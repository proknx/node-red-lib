[
    {
        "id": "5cb619a7.cb38e8",
        "type": "tab",
        "label": "SONY BRAVIA TV",
        "disabled": false,
        "info": ""
    },
    {
        "id": "52e9d8db.6bfb78",
        "type": "group",
        "z": "5cb619a7.cb38e8",
        "name": "CUSTOM MEDIA CONTROL FOR SONY BRAVIA TV",
        "style": {
            "label": true
        },
        "nodes": [
            "7572b9b4.550e48",
            "f1c5f285.02f82",
            "d84bfcba.219fd",
            "767c3cc0.6dd0a4",
            "21aa0320.197e2c",
            "640b6a4.2705094",
            "cee1456.fc761b8",
            "c9c1dd87.15326",
            "151785a1.5b461a",
            "c5ecc032.b0003",
            "b6665acd.8487c8",
            "10d2ecc7.9fccb3",
            "18c7557d.ce98fb",
            "af97c54f.555a28",
            "5fadd7d2.9a8ae8",
            "f3991fe.f8bd3e",
            "393a22d4.235f3e",
            "bdd7d317.eb1e9",
            "1029192a.792c47",
            "31b81f39.5b4fd",
            "a0524903.e66d58",
            "a516f26a.54c22",
            "536a6cad.0a4024",
            "cbd5ea7b.864938",
            "4d4583ac.a74c9c",
            "c751be83.bbd65",
            "94dd563d.fd7ef8",
            "251146ee.15fe1a",
            "f6e0c68e.623c98",
            "2d2bd1fe.8744de",
            "5cc2d10e.b6945",
            "8c3735fc.2fe498",
            "69b9e773.2f1dc8",
            "215c6f8a.84434",
            "c682251d.089108",
            "494ba95d.e1d478",
            "ee15cac3.c9ed18",
            "fea35ab3.fc3218",
            "c3949da6.8076c",
            "6b678aad.353e94",
            "d512befb.eee86",
            "afefc423.856f28",
            "3f370e8c.555af2",
            "4694b7ad.51d608",
            "2d7cd6aa.9129ba",
            "229a9693.c2ea3a",
            "e5a3404.6a8d4c",
            "8a657f4d.c131f",
            "92f0422e.0ba67",
            "13d3fa17.79c236",
            "9755ec2d.54d31",
            "369f6164.fbcb0e",
            "b846b833.608468",
            "ec431cc5.48c28",
            "a10179ea.68ecc8",
            "31f9f0fa.456cc",
            "7fbbe3df.06898c",
            "aef45fc1.bde35",
            "7c349373.7372ac",
            "ece67af.450e188",
            "64b9142d.22f9fc",
            "972c3bfb.1fce78",
            "10bd7bc7.3f9e74",
            "9827803f.d4e01",
            "17254540.68d00b",
            "bcfcf268.3fe4d",
            "8e95504b.0ad05",
            "f13e1d86.be0f5",
            "3b856c89.20b7e4",
            "976516bc.24a0a8",
            "1479cb72.1f5455",
            "d78f10a9.4f8ac",
            "e880f657.041788",
            "edd637a5.c5c788",
            "f43e5fe2.dcfaa",
            "581b1e84.8ed8f"
        ],
        "x": 139,
        "y": 34,
        "w": 827,
        "h": 1557
    },
    {
        "id": "6a5ae2b7.fcc24c",
        "type": "debug",
        "z": "5cb619a7.cb38e8",
        "name": "",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 825,
        "y": 165,
        "wires": [],
        "l": false
    },
    {
        "id": "c6cd4dfd.360a5",
        "type": "catch",
        "z": "5cb619a7.cb38e8",
        "name": "",
        "scope": [
            "979de30f.19ef6",
            "21aa0320.197e2c",
            "10d2ecc7.9fccb3",
            "18c7557d.ce98fb",
            "f3991fe.f8bd3e",
            "31b81f39.5b4fd",
            "a516f26a.54c22",
            "4d4583ac.a74c9c",
            "c751be83.bbd65",
            "94dd563d.fd7ef8",
            "251146ee.15fe1a",
            "f6e0c68e.623c98",
            "2d2bd1fe.8744de",
            "8c3735fc.2fe498",
            "69b9e773.2f1dc8",
            "215c6f8a.84434",
            "c682251d.089108",
            "494ba95d.e1d478",
            "ee15cac3.c9ed18",
            "fea35ab3.fc3218",
            "c3949da6.8076c",
            "6b678aad.353e94",
            "d512befb.eee86",
            "1433a862.4f4198",
            "afefc423.856f28",
            "4694b7ad.51d608",
            "2d7cd6aa.9129ba",
            "e5a3404.6a8d4c",
            "92f0422e.0ba67",
            "13d3fa17.79c236",
            "31f9f0fa.456cc",
            "7fbbe3df.06898c",
            "7c349373.7372ac",
            "972c3bfb.1fce78",
            "10bd7bc7.3f9e74",
            "9827803f.d4e01",
            "17254540.68d00b",
            "bcfcf268.3fe4d",
            "f13e1d86.be0f5",
            "3b856c89.20b7e4",
            "976516bc.24a0a8",
            "4f56e81b.5d3628",
            "1479cb72.1f5455",
            "e880f657.041788",
            "edd637a5.c5c788"
        ],
        "uncaught": false,
        "x": 725,
        "y": 165,
        "wires": [
            [
                "6a5ae2b7.fcc24c"
            ]
        ]
    },
    {
        "id": "7572b9b4.550e48",
        "type": "mqtt in",
        "z": "5cb619a7.cb38e8",
        "g": "52e9d8db.6bfb78",
        "name": "next",
        "topic": "hermes/intent/ProKNX:next",
        "qos": "2",
        "datatype": "auto",
        "broker": "6300ac18.111804",
        "x": 241,
        "y": 1205,
        "wires": [
            [
                "21aa0320.197e2c"
            ]
        ]
    },
    {
        "id": "f1c5f285.02f82",
        "type": "mqtt in",
        "z": "5cb619a7.cb38e8",
        "g": "52e9d8db.6bfb78",
        "name": "previous",
        "topic": "hermes/intent/ProKNX:previous",
        "qos": "2",
        "datatype": "auto",
        "broker": "6300ac18.111804",
        "x": 251,
        "y": 1245,
        "wires": [
            [
                "21aa0320.197e2c"
            ]
        ]
    },
    {
        "id": "d84bfcba.219fd",
        "type": "mqtt in",
        "z": "5cb619a7.cb38e8",
        "g": "52e9d8db.6bfb78",
        "name": "hotword off",
        "topic": "hermes/hotword/toggleOn",
        "qos": "2",
        "datatype": "auto",
        "broker": "6300ac18.111804",
        "x": 250,
        "y": 490,
        "wires": [
            [
                "c9c1dd87.15326"
            ]
        ]
    },
    {
        "id": "767c3cc0.6dd0a4",
        "type": "mqtt in",
        "z": "5cb619a7.cb38e8",
        "g": "52e9d8db.6bfb78",
        "name": "hotword on",
        "topic": "hermes/hotword/default/detected",
        "qos": "2",
        "datatype": "auto",
        "broker": "6300ac18.111804",
        "x": 250,
        "y": 441,
        "wires": [
            [
                "640b6a4.2705094"
            ]
        ]
    },
    {
        "id": "21aa0320.197e2c",
        "type": "function",
        "z": "5cb619a7.cb38e8",
        "g": "52e9d8db.6bfb78",
        "name": "Filter",
        "func": "// Sample code : control of TV set\n\nfunction findObjectByKey(array, key, value) {\n\titems = [];\n\tvar cpt = 0;\n\tfor (var i = 0; i < array.length; i++) {\n\t\tif (array[i][key] === value) {\n\t\t\titems[cpt] = array[i];\n\t\t\tcpt++;\n\t\t}\n\t}\n\tif (items[0] !== undefined) {\n\t\treturn items;\n\t} else {\n\t\treturn null;\n\t}\n}\n\nvar lang = global.get(\"msgLang\");\nvar defaultSpeaker = global.get(\"defaultSpeaker\");\nvar tvFavorites = global.get(\"tvFavorites\");\nvar siteIdTv = global.get(\"siteIdTv\");\nif(defaultSpeaker === undefined){\n    defaultSpeaker = \"speaker\";\n}\nmsg.cmd={};\nmsg.payload = JSON.parse(msg.payload);\nmsg.cmd.siteId = msg.payload.siteId.replace(/_\\d+$/, \"\").trim();\nvar doAllRooms = false;\nvar intent = msg.payload.intent.intentName;\nif (intent === undefined) \n    return null;\n\nif(msg.payload.input.toLowerCase().includes(\"snips\") === true){\n    //node.warn(\"send to snips: includes 'snips'\");\n    return null;   \n}\n\nvar rawRoom = findObjectByKey(msg.payload.slots, 'slotName', 'room');\nvar rawFavorite = findObjectByKey(msg.payload.slots, 'entity', 'FavoriteType');\nvar rawSpeaker = findObjectByKey(msg.payload.slots, 'entity', 'SpeakerType');\n\n//node.warn(msg.payload);\n//node.warn(\"rawRoom: \"+ JSON.stringify(rawRoom) );\nvar theRoom = msg.payload.siteId;\n\nif (rawRoom !== null) {\n\tmsg.cmd.room = [];\n\tfor (var i = 0; i < rawRoom.length; i++) {\n\t\tmsg.cmd.room[i] = rawRoom[i].value.value.toLowerCase();\n\t\t//node.warn(\"msg.cmd.room[i]: \"+msg.cmd.room[i] + \"   msg.payload.siteId: \"+msg.payload.siteId);\n\t\tif (msg.cmd.room[i] === \"here\" || msg.cmd.room[i] === \"hier\" || msg.cmd.room[i] === \"ici\") {\n\t\t\ttheRoom = msg.payload.siteId;\n\t\t} else {\n    \t\tif (msg.cmd.room[i] === \"all\" || msg.cmd.room[i] === \"everywhere\" || msg.cmd.room[i] === \"ueberall\" || msg.cmd.room[i] === \"partout\") {\n    \t\t    doAllRooms = true;\n    \t\t} else {\n    \t\t    theRoom = msg.cmd.room[i].replace(/ /g, \"_\");\n    \t\t}\n\t\t}\n\t}\n}\n\nif (rawSpeaker !== null) {\n    //node.warn(\"rawSpeaker: \"+JSON.stringify(rawSpeaker));\n    msg.payload.speaker = rawSpeaker[0].value.value.trim().toLowerCase();\n} else {\n    msg.payload.speaker = defaultSpeaker.trim().toLowerCase();\n}\n\nmsg.payload.siteId = theRoom;\n\nif(msg.payload.siteId.toLowerCase().replace(/_\\d+$/,\"\").replace(/_/g,\"\") !== siteIdTv.toLowerCase().replace(/_\\d+$/,\"\").replace(/ /g,\"\")){\n    return null;\n}\n\nif (rawFavorite !== null) {\n    //node.warn(\"rawFavorite: \"+JSON.stringify(rawFavorite));\n    msg.payload.favorite = rawFavorite[0].value.value.trim().toLowerCase();\n    node.warn(\"msg.payload.favorite: \"+msg.payload.favorite);\n}\n\n\n//node.warn(\"msg.payload.speaker: \"+msg.payload.speaker);\n    \nif (msg.payload.intent.confidenceScore < 0.6){\n    return null;\n}\n\n//node.warn(\"msg.payload.speaker = \" + msg.payload.speaker);\n\nif(msg.payload.speaker !== undefined){\n    if(msg.payload.speaker === \"tv\") {\n        \n        global.set(\"defaultSpeaker\", \"tv\");\n        //node.warn(\"intent \" + intent);\n        switch (intent) {\n            case \"ProKNX:next\": return [msg, null, null, null, null];\n            case \"ProKNX:previous\": return [null, msg, null, null, null];\n        }\n        \n        if (msg.payload.asrTokens[0].length <= 1){\n            return null;\n        }else{\n            switch(intent){\n            case \"ProKNX:increaseVolume\": return [null, null, msg, null, null];\n            case \"ProKNX:decreaseVolume\": return [null, null, null, msg, null];\n            case \"ProKNX:setVolume\": flow.set(\"rawLoudness\", findObjectByKey(msg.payload.slots, 'slotName', 'loudness')); flow.set(\"rawMin\", findObjectByKey(msg.payload.slots, 'slotName', 'min'));\n                                    flow.set(\"rawMax\", findObjectByKey(msg.payload.slots, 'slotName', 'max')); return [null, null, null, null, msg];\n            }\n        }\n    }\n}",
        "outputs": 5,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "x": 389,
        "y": 1290,
        "wires": [
            [
                "972c3bfb.1fce78"
            ],
            [
                "17254540.68d00b"
            ],
            [
                "494ba95d.e1d478"
            ],
            [
                "ee15cac3.c9ed18"
            ],
            [
                "c3949da6.8076c"
            ]
        ],
        "outputLabels": [
            "pause",
            "play",
            "next",
            "previous",
            "incvol"
        ]
    },
    {
        "id": "640b6a4.2705094",
        "type": "json",
        "z": "5cb619a7.cb38e8",
        "g": "52e9d8db.6bfb78",
        "name": "",
        "property": "payload",
        "action": "",
        "pretty": false,
        "x": 365,
        "y": 441,
        "wires": [
            [
                "cee1456.fc761b8"
            ]
        ],
        "l": false
    },
    {
        "id": "cee1456.fc761b8",
        "type": "delay",
        "z": "5cb619a7.cb38e8",
        "g": "52e9d8db.6bfb78",
        "name": "",
        "pauseType": "rate",
        "timeout": "5",
        "timeoutUnits": "seconds",
        "rate": "1",
        "nbRateUnits": "1",
        "rateUnits": "second",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": true,
        "x": 423,
        "y": 441,
        "wires": [
            [
                "369f6164.fbcb0e"
            ]
        ],
        "l": false
    },
    {
        "id": "c9c1dd87.15326",
        "type": "json",
        "z": "5cb619a7.cb38e8",
        "g": "52e9d8db.6bfb78",
        "name": "",
        "property": "payload",
        "action": "",
        "pretty": false,
        "x": 365,
        "y": 490,
        "wires": [
            [
                "b846b833.608468"
            ]
        ],
        "l": false
    },
    {
        "id": "151785a1.5b461a",
        "type": "comment",
        "z": "5cb619a7.cb38e8",
        "g": "52e9d8db.6bfb78",
        "name": "Info - README V2.0",
        "info": "This is version 2.0 of custom media control for SONY BRAVIA TV\n\nIn this version, the tv favorites are generated automatically from the TV channel list. \n\n*************************************************\n\nThe following nodes let you implement custom media control for Sony Bravia TV,\n\n**IMPORTANT :** To avoid your custom code is removed on flow update it is recommended to copy paste the nodes below to a new Tab\n\nTo apply this function it to your tv, you need to change the ip address of the tv\n\nTo change, go to configurations nodes and find SONY BRAVIA TV node and double click it\nChange the host to your tv's ip address and type in the PSK and save\n\n> NOTE : It is advised to set a static IP, see the network settings of the TV.\n",
        "x": 265,
        "y": 75,
        "wires": []
    },
    {
        "id": "c5ecc032.b0003",
        "type": "inject",
        "z": "5cb619a7.cb38e8",
        "g": "52e9d8db.6bfb78",
        "name": "French favorites (samples)",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": true,
        "onceDelay": "10",
        "topic": "",
        "payload": "[\"Canal\"]",
        "payloadType": "json",
        "x": 320,
        "y": 250,
        "wires": [
            [
                "10d2ecc7.9fccb3"
            ]
        ]
    },
    {
        "id": "b6665acd.8487c8",
        "type": "inject",
        "z": "5cb619a7.cb38e8",
        "g": "52e9d8db.6bfb78",
        "name": "German favorites (samples)",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": true,
        "onceDelay": "10",
        "topic": "",
        "payload": "[\"Kanal\"]",
        "payloadType": "json",
        "x": 320,
        "y": 290,
        "wires": [
            [
                "18c7557d.ce98fb"
            ]
        ]
    },
    {
        "id": "10d2ecc7.9fccb3",
        "type": "function",
        "z": "5cb619a7.cb38e8",
        "g": "52e9d8db.6bfb78",
        "name": "lang?",
        "func": "var lang = global.get(\"msgLang\");\nif(lang.toLowerCase().includes(\"fr\")){\n\n    var channelList = global.get(\"channelList\");\n    var appList = global.get(\"appList\");\n    \n    if(channelList !== undefined){\n        msg.payload = [...msg.payload, ...channelList];\n    }\n    if(appList !== undefined){\n        msg.payload = [...msg.payload, ...appList];\n    }\n    \n    return msg;\n}\nelse {\n    //do nothing\n}",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "x": 560,
        "y": 250,
        "wires": [
            [
                "af97c54f.555a28"
            ]
        ]
    },
    {
        "id": "18c7557d.ce98fb",
        "type": "function",
        "z": "5cb619a7.cb38e8",
        "g": "52e9d8db.6bfb78",
        "name": "lang?",
        "func": "var lang = global.get(\"msgLang\");\nif(lang.toLowerCase().includes(\"de\")){\n\n    var channelList = global.get(\"channelList\");\n    var appList = global.get(\"appList\");\n    \n    if(channelList !== undefined){\n        msg.payload = [...msg.payload, ...channelList];\n    }\n    if(appList !== undefined){\n        msg.payload = [...msg.payload, ...appList];\n    }\n    \n    return msg;\n}\nelse {\n    //do nothing\n}",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "x": 560,
        "y": 290,
        "wires": [
            [
                "af97c54f.555a28"
            ]
        ]
    },
    {
        "id": "5fadd7d2.9a8ae8",
        "type": "inject",
        "z": "5cb619a7.cb38e8",
        "g": "52e9d8db.6bfb78",
        "name": "English favorites (samples)",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": true,
        "onceDelay": "10",
        "topic": "",
        "payload": "[\"Channel\"]",
        "payloadType": "json",
        "x": 320,
        "y": 330,
        "wires": [
            [
                "f3991fe.f8bd3e"
            ]
        ]
    },
    {
        "id": "f3991fe.f8bd3e",
        "type": "function",
        "z": "5cb619a7.cb38e8",
        "g": "52e9d8db.6bfb78",
        "name": "lang?",
        "func": "var lang = global.get(\"msgLang\");\nif(lang.toLowerCase().includes(\"en\")){\n\n    var channelList = global.get(\"channelList\");\n    var appList = global.get(\"appList\");\n    \n    if(channelList !== undefined){\n        msg.payload = [...msg.payload, ...channelList];\n    }\n    if(appList !== undefined){\n        msg.payload = [...msg.payload, ...appList];\n    }\n    \n    return msg;\n}\nelse {\n    //do nothing\n}",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "x": 560,
        "y": 330,
        "wires": [
            [
                "af97c54f.555a28"
            ]
        ]
    },
    {
        "id": "393a22d4.235f3e",
        "type": "mqtt in",
        "z": "5cb619a7.cb38e8",
        "g": "52e9d8db.6bfb78",
        "name": "incVol",
        "topic": "hermes/intent/ProKNX:increaseVolume",
        "qos": "2",
        "datatype": "auto",
        "broker": "6300ac18.111804",
        "x": 240,
        "y": 1290,
        "wires": [
            [
                "21aa0320.197e2c"
            ]
        ]
    },
    {
        "id": "bdd7d317.eb1e9",
        "type": "mqtt in",
        "z": "5cb619a7.cb38e8",
        "g": "52e9d8db.6bfb78",
        "name": "decVol",
        "topic": "hermes/intent/ProKNX:decreaseVolume",
        "qos": "2",
        "datatype": "auto",
        "broker": "6300ac18.111804",
        "x": 240,
        "y": 1330,
        "wires": [
            [
                "21aa0320.197e2c"
            ]
        ]
    },
    {
        "id": "1029192a.792c47",
        "type": "mqtt in",
        "z": "5cb619a7.cb38e8",
        "g": "52e9d8db.6bfb78",
        "name": "setVol",
        "topic": "hermes/intent/ProKNX:setVolume",
        "qos": "2",
        "datatype": "auto",
        "broker": "6300ac18.111804",
        "x": 240,
        "y": 1370,
        "wires": [
            [
                "21aa0320.197e2c"
            ]
        ]
    },
    {
        "id": "31b81f39.5b4fd",
        "type": "bravia-ircc",
        "z": "5cb619a7.cb38e8",
        "g": "52e9d8db.6bfb78",
        "tv": "204aae5a.40fb72",
        "ircc": "Prev",
        "name": "Previous",
        "x": 695,
        "y": 1205,
        "wires": []
    },
    {
        "id": "a0524903.e66d58",
        "type": "mqtt in",
        "z": "5cb619a7.cb38e8",
        "g": "52e9d8db.6bfb78",
        "name": "play",
        "topic": "hermes/intent/ProKNX:play",
        "qos": "2",
        "datatype": "auto",
        "broker": "6300ac18.111804",
        "x": 239,
        "y": 640,
        "wires": [
            [
                "a516f26a.54c22"
            ]
        ]
    },
    {
        "id": "a516f26a.54c22",
        "type": "function",
        "z": "5cb619a7.cb38e8",
        "g": "52e9d8db.6bfb78",
        "name": "Play",
        "func": "//NOMINIFY\n// License: 562c0ffe-df98-4348-87b7-e60e3c37c534\n\n(function() {\n\nvar FuzzySet = function(arr, useLevenshtein, gramSizeLower, gramSizeUpper) {\n    var fuzzyset = {\n\n    };\n\n    // default options\n    arr = arr || [];\n    fuzzyset.gramSizeLower = gramSizeLower || 2;\n    fuzzyset.gramSizeUpper = gramSizeUpper || 3;\n    fuzzyset.useLevenshtein = (typeof useLevenshtein !== 'boolean') ? true : useLevenshtein;\n\n    // define all the object functions and attributes\n    fuzzyset.exactSet = {};\n    fuzzyset.matchDict = {};\n    fuzzyset.items = {};\n\n    // helper functions\n    var levenshtein = function(str1, str2) {\n        var current = [], prev, value;\n\n        for (var i = 0; i <= str2.length; i++)\n            for (var j = 0; j <= str1.length; j++) {\n            if (i && j)\n                if (str1.charAt(j - 1) === str2.charAt(i - 1))\n                value = prev;\n                else\n                value = Math.min(current[j], current[j - 1], prev) + 1;\n            else\n                value = i + j;\n\n            prev = current[j];\n            current[j] = value;\n            }\n\n        return current.pop();\n    };\n\n    // return an edit distance from 0 to 1\n    var _distance = function(str1, str2) {\n        if (str1 === null && str2 === null) throw 'Trying to compare two null values';\n        if (str1 === null || str2 === null) return 0;\n        str1 = String(str1); str2 = String(str2);\n\n        var distance = levenshtein(str1, str2);\n        if (str1.length > str2.length) {\n            return 1 - distance / str1.length;\n        } else {\n            return 1 - distance / str2.length;\n        }\n    };\n    var _nonWordRe = /[^a-zA-Z0-9\\u00C0-\\u00FF, ]+/g;\n\n    var _iterateGrams = function(value, gramSize) {\n        gramSize = gramSize || 2;\n        var simplified = '-' + value.toLowerCase().replace(_nonWordRe, '') + '-',\n            lenDiff = gramSize - simplified.length,\n            results = [];\n        if (lenDiff > 0) {\n            for (var i = 0; i < lenDiff; ++i) {\n                simplified += '-';\n            }\n        }\n        for (var i = 0; i < simplified.length - gramSize + 1; ++i) {\n            results.push(simplified.slice(i, i + gramSize));\n        }\n        return results;\n    };\n\n    var _gramCounter = function(value, gramSize) {\n        // return an object where key=gram, value=number of occurrences\n        gramSize = gramSize || 2;\n        var result = {},\n            grams = _iterateGrams(value, gramSize),\n            i = 0;\n        for (i; i < grams.length; ++i) {\n            if (grams[i] in result) {\n                result[grams[i]] += 1;\n            } else {\n                result[grams[i]] = 1;\n            }\n        }\n        return result;\n    };\n\n    // the main functions\n    fuzzyset.get = function(value, defaultValue, minMatchScore) {\n        // check for value in set, returning defaultValue or null if none found\n        if (minMatchScore === undefined) {\n            minMatchScore = .33\n        }\n        var result = this._get(value, minMatchScore);\n        if (!result && typeof defaultValue !== 'undefined') {\n            return defaultValue;\n        }\n        return result;\n    };\n\n    fuzzyset._get = function(value, minMatchScore) {\n        var results = [];\n        // start with high gram size and if there are no results, go to lower gram sizes\n        for (var gramSize = this.gramSizeUpper; gramSize >= this.gramSizeLower; --gramSize) {\n            results = this.__get(value, gramSize, minMatchScore);\n            if (results && results.length > 0) {\n                return results;\n            }\n        }\n        return null;\n    };\n\n    fuzzyset.__get = function(value, gramSize, minMatchScore) {\n        var normalizedValue = this._normalizeStr(value),\n            matches = {},\n            gramCounts = _gramCounter(normalizedValue, gramSize),\n            items = this.items[gramSize],\n            sumOfSquareGramCounts = 0,\n            gram,\n            gramCount,\n            i,\n            index,\n            otherGramCount;\n\n        for (gram in gramCounts) {\n            gramCount = gramCounts[gram];\n            sumOfSquareGramCounts += Math.pow(gramCount, 2);\n            if (gram in this.matchDict) {\n                for (i = 0; i < this.matchDict[gram].length; ++i) {\n                    index = this.matchDict[gram][i][0];\n                    otherGramCount = this.matchDict[gram][i][1];\n                    if (index in matches) {\n                        matches[index] += gramCount * otherGramCount;\n                    } else {\n                        matches[index] = gramCount * otherGramCount;\n                    }\n                }\n            }\n        }\n\n        function isEmptyObject(obj) {\n            for(var prop in obj) {\n                if(obj.hasOwnProperty(prop))\n                    return false;\n            }\n            return true;\n        }\n\n        if (isEmptyObject(matches)) {\n            return null;\n        }\n\n        var vectorNormal = Math.sqrt(sumOfSquareGramCounts),\n            results = [],\n            matchScore;\n        // build a results list of [score, str]\n        for (var matchIndex in matches) {\n            matchScore = matches[matchIndex];\n            results.push([matchScore / (vectorNormal * items[matchIndex][0]), items[matchIndex][1]]);\n        }\n        var sortDescending = function(a, b) {\n            if (a[0] < b[0]) {\n                return 1;\n            } else if (a[0] > b[0]) {\n                return -1;\n            } else {\n                return 0;\n            }\n        };\n        results.sort(sortDescending);\n        if (this.useLevenshtein) {\n            var newResults = [],\n                endIndex = Math.min(50, results.length);\n            // truncate somewhat arbitrarily to 50\n            for (var i = 0; i < endIndex; ++i) {\n                newResults.push([_distance(results[i][1], normalizedValue), results[i][1]]);\n            }\n            results = newResults;\n            results.sort(sortDescending);\n        }\n        newResults = [];\n        results.forEach(function(scoreWordPair) {\n            if (scoreWordPair[0] >= minMatchScore) {\n                newResults.push([scoreWordPair[0], this.exactSet[scoreWordPair[1]]]);\n            }\n        }.bind(this))\n        return newResults;\n    };\n\n    fuzzyset.add = function(value) {\n        var normalizedValue = this._normalizeStr(value);\n        if (normalizedValue in this.exactSet) {\n            return false;\n        }\n\n        var i = this.gramSizeLower;\n        for (i; i < this.gramSizeUpper + 1; ++i) {\n            this._add(value, i);\n        }\n    };\n\n    fuzzyset._add = function(value, gramSize) {\n        var normalizedValue = this._normalizeStr(value),\n            items = this.items[gramSize] || [],\n            index = items.length;\n\n        items.push(0);\n        var gramCounts = _gramCounter(normalizedValue, gramSize),\n            sumOfSquareGramCounts = 0,\n            gram, gramCount;\n        for (gram in gramCounts) {\n            gramCount = gramCounts[gram];\n            sumOfSquareGramCounts += Math.pow(gramCount, 2);\n            if (gram in this.matchDict) {\n                this.matchDict[gram].push([index, gramCount]);\n            } else {\n                this.matchDict[gram] = [[index, gramCount]];\n            }\n        }\n        var vectorNormal = Math.sqrt(sumOfSquareGramCounts);\n        items[index] = [vectorNormal, normalizedValue];\n        this.items[gramSize] = items;\n        this.exactSet[normalizedValue] = value;\n    };\n\n    fuzzyset._normalizeStr = function(str) {\n        if (Object.prototype.toString.call(str) !== '[object String]') throw 'Must use a string as argument to FuzzySet functions';\n        return str.toLowerCase();\n    };\n\n    // return length of items in set\n    fuzzyset.length = function() {\n        var count = 0,\n            prop;\n        for (prop in this.exactSet) {\n            if (this.exactSet.hasOwnProperty(prop)) {\n                count += 1;\n            }\n        }\n        return count;\n    };\n\n    // return is set is empty\n    fuzzyset.isEmpty = function() {\n        for (var prop in this.exactSet) {\n            if (this.exactSet.hasOwnProperty(prop)) {\n                return false;\n            }\n        }\n        return true;\n    };\n\n    // return list of values loaded into set\n    fuzzyset.values = function() {\n        var values = [],\n            prop;\n        for (prop in this.exactSet) {\n            if (this.exactSet.hasOwnProperty(prop)) {\n                values.push(this.exactSet[prop]);\n            }\n        }\n        return values;\n    };\n\n\n    // initialization\n    var i = fuzzyset.gramSizeLower;\n    for (i; i < fuzzyset.gramSizeUpper + 1; ++i) {\n        fuzzyset.items[i] = [];\n    }\n    // add all the items to the set\n    for (i = 0; i < arr.length; ++i) {\n        fuzzyset.add(arr[i]);\n    }\n\n    return fuzzyset;\n};\n\nvar root = this;\n// Export the fuzzyset object for **CommonJS**, with backwards-compatibility\n// for the old `require()` API. If we're not in CommonJS, add `_` to the\n// global object.\nif (typeof module !== 'undefined' && module.exports) {\n    module.exports = FuzzySet;\n    if(root)\n    {\n        root.FuzzySet = FuzzySet;\n    }\n} else {\n    root.FuzzySet = FuzzySet;\n}\n\n})();\n\n\nString.prototype.replaceWithDigits = function(){\n    \n    if(lang == \"de\"){\n        \n        var number = [\"Neunundneunzig\",\"Neunundachtzig\",\"Neunundsiebzig\",\"Neunundsechzig\",\"Neunundfünfzig\",\"Neunundvierzig\",\"Neununddreiβig\",\"Neunundzwanzig\",\"Neunzehn\",\n            \"Achtundneunzig\",\"Achtundachtzig\",\"Achtundsiebzig\",\"Achtundsechzig\",\"Achtundfünfzig\",\"Achtundvierzig\",\"Achtunddreiβig\",\"Achtundzwanzig\",\"Achtzehn\",\n            \"Siebenundneunzig\",\"Siebenundachtzig\",\"Siebenundsiebzig\",\"Siebenundsechzig\",\"Siebenundfünfzig\",\"Siebenundvierzig\",\"Siebenunddreiβig\",\"Siebenundzwanzig\",\"Siebzehn\",\n            \"Sechsundneunzig\",\"Sechsundachtzig\",\"Sechsundsiebzig\",\"Sechsundsechzig\",\"Sechsundfünfzig\",\"Sechsundvierzig\",\"Sechsunddreiβig\",\"Sechsundzwanzig\",\"Sechzehn\",\n            \"Fünfundneunzig\",\"Fünfundachtzig\",\"Fünfundsiebzig\",\"Fünfundsechzig\",\"Fünfundfünfzig\",\"Fünfundvierzig\",\"Fünfunddreiβig\",\"Fünfundzwanzig\",\"Fünfzehn\",\n            \"Vierundneunzig\",\"Vierundachtzig\",\"Vierundsiebzig\",\"Vierundsechzig\",\"Vierundfünfzig\",\"Vierundvierzig\",\"Vierunddreiβig\",\"Vierundzwanzig\",\"Vierzehn\",\n            \"Dreiundneunzig\",\"Dreiundachtzig\",\"Dreiundsiebzig\",\"Dreiundsechzig\",\"Dreiundfünfzig\",\"Dreiundvierzig\",\"Dreiunddreiβig\",\"Dreiundzwanzig\",\"Dreizehn\",\n            \"Zweiundneunzig\",\"Zweiundachtzig\",\"Zweiundsiebzig\",\"Zweiundsechzig\",\"Zweiundfünfzig\",\"Zweiundvierzig\",\"Zweiunddreiβig\",\"Zweiundzwanzig\",\"Zwölf\",\n            \"Einundneunzig\",\"Einundachtzig\",\"Einundsiebzig\",\"Einundsechzig\",\"Einundfünfzig\",\"Einundvierzig\",\"Einunddreiβig\",\"Einundzwanzig\",\"Elf\",\n            \"Einhundert\",\"Neunzig\",\"Achtzig\",\"Siebzig\",\"Sechzig\",\"Fünfzig\",\"Vierzig\",\"Dreiβig\",\"Zwanzig\",\"Zehn\",\"Neun\",\"Acht\",\"Sieben\",\"Sechs\",\"Fünf\",\"Vier\",\"Drei\",\"Zwei\",\"Eins\"\n        ];\n\n        \n    }else if(lang == \"fr\"){\n        \n        var number = [\"Quatre-vingt-dix-neuf\",\"Quatre-vingt-neuf\",\"Soixante-dix-neuf \",\"Soixante-neuf\",\"Cinquante-neuf\",\"Quarante-neuf\",\" Trente-neuf \",\" Vingt-neuf \",\"Dix-neuf\",\n            \"Quatre-vingt-dix-huit\",\"Quatre-vingt-huit\", \"Soixante-dix-huit\",\" Soixante-huit\",\"Cinquante-huit\",\"Quarante-huit\",\"Trente-huit\",\"Vingt-huit\",\"Dix-huit\",\n            \"Quatre-vingt-dix-sept\",\"Quatre-vingt-sept\",\"Soixante-dix-sept\",\"Soixante-sept\",\"Cinquante-sept\",\"Quarante-sept\",\"Trente-sept\",\"Vingt-sept\",\"Dix-sept\",\n            \"Quatre-vingt-seize\",\"Quatre-vingt-six\",\"Soixante-six\",\"Soixante-six\",\"Cinquante-six\",\"Quarante-six\",\"Trente-six\",\"Vingt-six\",\"Seize\",\n            \"Quatre-vingt-quinze\",\"Quatre-vingt-cinq\",\"Soixante-quinze\",\"Soixante-cinq\",\"Cinquante-cinq\",\"Quarante-cinq\",\"Trente-cinq\",\"Vingt-cinq\",\"Quinze\",\n            \"Quatre-vingt-quatorze\",\"Quatre-vingt-quatre\",\"Soixante-quatorze\",\"Soixante-quatre\",\"Cinquante-quatre\",\"Quarante-quatre\",\"Trente-quatre\",\"Vingt-quatre\",\"Quatorze\",\n            \"Quatre-vingt-treize\",\"Quatre-vingt-trois\",\"Soixante-treize\",\"Soixante-trois\",\"Cinquante-trois\",\"Quarante-trois\",\"Trente-trois\",\"Vingt-trois\",\"Treize\",\n            \"Quatre-vingt-douze\",\"Quatre-vingt-deux\",\"Soixante-douze\",\"Soixante-deux\",\"Cinquante-deux\",\"Quarante-deux\",\"Trente-deux\",\"Vingt-deux\",\"Douze\",\n            \"Quatre-vingt-onze\",\"Quatre-vingt-un\",\"Soixante et onze\",\"Soixante et un\",\"Cinquante et un\",\"Quarante et un\",\"Trente et un\",\"Vingt et un\",\"Onze\",\n            \"Cent\",\"Quatre-vingt-dix\",\"Quatre-vingt\",\"Soixante-dix\",\"Soixante\",\"Cinquante\",\"Quarante\",\"Trente\",\"Vingt\",\"Dix\",\n            \"Neuf\",\"Huit\",\"Sept\",\"Six\",\"Cinq\",\"Quatre\",\"Trois\",\"Deux\",\"Un\"\n        ];\n        \n    }else{\n        \n        var number = [\"Ninety-nine\",\"Eighty-nine\",\"Seventy-nine\",\"Sixty-nine\",\"Fifty-nine\",\"Forty-nine\",\"Thirty-nine\",\"Twenty-nine\",\"Nineteen\",\n            \"Ninety-eight\",\"Eighty-eight\",\"Seventy-eight\",\"Sixty-eight\",\"Fifty-eight\",\"Forty-eight\",\"Thirty-eight\",\"Twenty-eight\",\"Eighteen\",\n            \"Ninety-seven\",\"Eighty-seven\",\"Seventy-seven\",\"Sixty-seven\",\"Fifty-seven\",\"Forty-seven\",\"Thirty-seven\",\"Twenty-seven\",\"Seventeen\",\n            \"Ninety-six\",\"Eighty-six\",\"Seventy-six\",\"Sixty-six\",\"Fifty-six\",\"Forty-six\",\"Thirty-six\",\"Twenty-six\",\"Sixteen\",\n            \"Ninety-five\",\"Eighty-five\",\"Seventy-five\",\"Sixty-five\",\"Fifty-five\",\"Forty-five\",\"Thirty-five\",\"Twenty-five\",\"Fifteen\",\n            \"Ninety-four\",\"Eighty-four\",\"Seventy-four\",\"Sixty-four\",\"Fifty-four\",\"Forty-four\",\"Thirty-four\",\"Twenty-four\",\"Fourteen\",\n            \"Ninety-three\",\"Eighty-three\",\"Seventy-three\",\"Sixty-three\",\"Fifty-three\",\"Forty-three\",\"Thirty-three\",\"Twenty-three\",\"Thirteen\",\n            \"Ninety-two\",\"Eighty-two\",\"Seventy-two\",\"Sixty-two\",\"Fifty-two\",\"Forty-two\",\"Thirty-two\",\"Twenty-two\",\"Twelve\",\n            \"Ninety-one\",\"Eighty-one\",\"Seventy-one\",\"Sixty-one\",\"Fifty-one\",\"Forty-one\",\"Thirty-one\",\"Twenty-one\",\"Eleven\",\n            \"One Hundred\",\"Ninety\",\"Eighty\",\"Seventy\",\"Sixty\",\"Fifty\",\"Forty\",\"Thirty\",\"Twenty\",\"Ten\",\n            \"Nine\",\"Eight\",\"Seven\",\"Six\",\"Five\",\"Four\",\"Three\",\"Two\",\"One\"\n        ];\n        \n    }\n    \n    var digit = [\"99\",\"89\",\"79\",\"69\",\"59\",\"49\",\"39\",\"29\",\"19\",\n        \"98\",\"88\",\"78\",\"68\",\"58\",\"48\",\"38\",\"28\",\"18\",\n        \"97\",\"87\",\"77\",\"67\",\"57\",\"47\",\"37\",\"27\",\"17\",\n        \"96\",\"86\",\"76\",\"66\",\"56\",\"46\",\"36\",\"26\",\"16\",\n        \"95\",\"85\",\"75\",\"65\",\"55\",\"45\",\"35\",\"25\",\"15\",\n        \"94\",\"84\",\"74\",\"64\",\"54\",\"44\",\"34\",\"24\",\"14\",\n        \"93\",\"83\",\"73\",\"63\",\"53\",\"43\",\"33\",\"23\",\"13\",\n        \"92\",\"82\",\"72\",\"62\",\"52\",\"42\",\"32\",\"22\",\"12\",\n        \"91\",\"81\",\"71\",\"61\",\"51\",\"41\",\"31\",\"21\",\"11\",\n        \"100\",\"90\",\"80\",\"70\",\"60\",\"50\",\"40\",\"30\",\"20\",\"10\",\n        \"9\",\"8\",\"7\",\"6\",\"5\",\"4\",\"3\",\"2\",\"1\"\n    ];\n    \n    var str = this;\n    for(var i = 0; i < number.length; i++){\n        str = str.replace(\"-\", \" \").replace(number[i].toLowerCase().replace(\"-\", \" \").trim(), digit[i]);\n    }\n     \n    return str;\n}\n\n\nfunction findObjectByKey(array, key, value) {\n\titems = [];\n\tvar cpt = 0;\n\tfor (var i = 0; i < array.length; i++) {\n\t\tif (array[i][key] === value) {\n\t\t\titems[cpt] = array[i];\n\t\t\tcpt++;\n\t\t}\n\t}\n\tif (items[0] !== undefined) {\n\t\treturn items;\n\t} else {\n\t\treturn null;\n\t}\n}\n\nvar lang = global.get(\"msgLang\");\nvar defaultSpeaker = global.get(\"defaultSpeaker\");\nvar tvFavorites = global.get(\"tvFavorites\");\nvar channelList = global.get(\"channelList\");\nvar setScreen = flow.get(\"setScreen\");\nvar siteIdTv = global.get(\"siteIdTv\");\nif(defaultSpeaker === undefined){\n    defaultSpeaker = \"speaker\";\n}\nmsg.cmd={};\nmsg.payload = JSON.parse(msg.payload);\nmsg.cmd.siteId = msg.payload.siteId.replace(/_\\d+$/, \"\").trim();\nvar doAllRooms = false;\nvar intent = msg.payload.intent.intentName;\nif (intent === undefined) \n    return null;\n\nvar rawRoom = findObjectByKey(msg.payload.slots, 'slotName', 'room');\nvar rawFavorite = findObjectByKey(msg.payload.slots, 'entity', 'FavoriteType');\nvar rawSpeaker = findObjectByKey(msg.payload.slots, 'entity', 'SpeakerType');\n\n//node.warn(msg.payload);\n//node.warn(\"rawRoom: \"+ JSON.stringify(rawRoom) );\nvar theRoom = msg.payload.siteId;\n\nif (rawRoom !== null) {\n\tmsg.cmd.room = [];\n\tfor (var i = 0; i < rawRoom.length; i++) {\n\t\tmsg.cmd.room[i] = rawRoom[i].value.value.toLowerCase();\n\t\t//node.warn(\"msg.cmd.room[i]: \"+msg.cmd.room[i] + \"   msg.payload.siteId: \"+msg.payload.siteId);\n\t\tif (msg.cmd.room[i] === \"here\" || msg.cmd.room[i] === \"hier\" || msg.cmd.room[i] === \"ici\") {\n\t\t\ttheRoom = msg.payload.siteId;\n\t\t} else {\n    \t\tif (msg.cmd.room[i] === \"all\" || msg.cmd.room[i] === \"everywhere\" || msg.cmd.room[i] === \"ueberall\" || msg.cmd.room[i] === \"partout\") {\n    \t\t    doAllRooms = true;\n    \t\t} else {\n    \t\t    theRoom = msg.cmd.room[i].replace(/ /g, \"_\");\n    \t\t}\n\t\t}\n\t}\n}\n\nif (rawSpeaker !== null) {\n    //node.warn(\"rawSpeaker: \"+JSON.stringify(rawSpeaker));\n    msg.payload.speaker = rawSpeaker[0].value.value.trim().toLowerCase();\n} else {\n    msg.payload.speaker = defaultSpeaker.trim().toLowerCase();\n}\n\nmsg.payload.siteId = theRoom;\n\nif(msg.payload.siteId.toLowerCase().replace(/_\\d+$/,\"\").replace(/_/g,\"\") !== siteIdTv.toLowerCase().replace(/_\\d+$/,\"\").replace(/ /g,\"\")){\n    return null;\n}\n\n//node.warn(\" Will use msg.payload.siteId: \"+msg.payload.siteId);\n//global.set(\"siteIdTv\", msg.payload.siteId);\n\nif (rawFavorite !== null) {\n    //node.warn(\"rawFavorite: \"+JSON.stringify(rawFavorite));\n    msg.payload.favorite = rawFavorite[0].value.value.trim().toLowerCase();\n\n    global.set(\"msg.payload.favorite\", msg.payload.favorite);\n    \n    var channel = channelList.find(\n            function(str) { return str.toLowerCase() == msg.payload.favorite.toLowerCase(); }\n        );\n    \n    if (channel !== undefined) {\n        \n        flow.set(\"setScreen\", \"channel\");\n        \n    }\n    \n    var found = tvFavorites.find(\n            function(str) { return str.toLowerCase() == msg.payload.favorite.toLowerCase(); }\n        );\n        \n    \n    if (found !== undefined) {\n        \n        global.set(\"defaultSpeaker\", \"tv\");\n        flow.set(\"tvPlay\", JSON.stringify(msg.payload));\n        return [null, msg];\n        \n    }\n}else{\n    \n    global.set(\"defaultSpeaker\", \"tv\");\n    if(setScreen === \"channel\"){\n        flow.set(\"tvPlay\", JSON.stringify(msg.payload));\n        return [null, msg];\n    }\n}\n\n//var msgFavorite = msg;\nvar sonosPlaylists = global.get(\"sonosPlaylists\");\nvar sonosFavorites = global.get(\"sonosFavorites\");  \n\nif(msg.payload.favorite !== undefined){\n\n    var searchItem = msg.payload.favorite;\n    //node.warn(\"searchItem : \"+searchItem);\n    \n    var found1 = sonosPlaylists.find(\n        function(str) { return str.toLowerCase() == searchItem.toLowerCase(); }\n        );\n    \n    var found2 = sonosFavorites.find(\n            function(str) { return str.toLowerCase() == searchItem.toLowerCase(); }\n        );\n    \n    if(found1 !== undefined || found2 !== undefined){\n        return null;\n    }\n}\n\n//node.warn(\"msg.payload.speaker: \"+msg.payload.speaker);\n\n  \nif (msg.payload.intent.confidenceScore < 0.2 || msg.payload.asrTokens!== undefined && msg.payload.asrTokens[0].length <= 1){\n    return null;\n}\n\nif(msg.payload.speaker === \"tv\"){\n    \n    var searchItem = msg.payload.input.toLowerCase()\n                    .replace(msg.payload.siteId, \"\")\n                    .replace(\"unknownword\", \"\")\n                    .replace(\"watch\", \"\")\n                    .replace(\"play\", \"\")\n                    .replace(\"open\", \"\")\n                    .replace(\"tv\", \"\")\n                    .replace(\"tee vee\", \"\")\n                    .replace(\"spielen\", \"\")\n                    .replace(\"öffnen\", \"\")\n                    .replace(\"fernseher\", \"\")\n                    .replace(\"regarder\", \"\")\n                    .replace(\"jouer\", \"\")\n                    .replace(\"joue\", \"\")\n                    .replace(\"mets\", \"\")\n                    .replace(\"met\", \"\")\n                    .replace(\"plus\", \"+\")\n                    .replaceWithDigits().trim();\n                    \n    if(searchItem.length>0){\n        \n        node.warn(\"searchItem : \" + searchItem);\n        \n        var fuzzyMatchItem = \"\";\n        \n        var a = FuzzySet(tvFavorites, false);\n        var scoreArr = a.get(searchItem);\n        node.warn(\"scoreArr: \"+scoreArr);\n        if(scoreArr !== null && scoreArr[0][0]>0.1){\n            fuzzyMatchItem = scoreArr[0][1];\n            msg.payload.favorite = fuzzyMatchItem;\n            node.warn(\"fuzzyMatchItem : \" + fuzzyMatchItem);\n            \n            var channel = channelList.find(\n                    function(str) { return str.toLowerCase() == fuzzyMatchItem.toLowerCase(); }\n                );\n            \n            if (channel !== undefined) {\n                flow.set(\"setScreen\", \"channel\");\n            }\n            \n            var found = tvFavorites.find(\n                function(str) { return str.toLowerCase() == fuzzyMatchItem.toLowerCase(); }\n            );\n            \n            node.warn(\"found is not undefined\");\n            global.set(\"msg.payload.favorite\", fuzzyMatchItem);\n            global.set(\"defaultSpeaker\", \"tv\");\n            flow.set(\"tvPlay\", JSON.stringify(msg.payload));\n            \n            return [null, msg];\n            \n        }\n    }\n    \n    global.set(\"defaultSpeaker\", \"tv\");\n    flow.set(\"tvPlay\", JSON.stringify(msg.payload));\n    return [msg, null];\n    \n}",
        "outputs": 2,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "x": 369,
        "y": 640,
        "wires": [
            [
                "2d2bd1fe.8744de"
            ],
            [
                "92f0422e.0ba67"
            ]
        ]
    },
    {
        "id": "536a6cad.0a4024",
        "type": "mqtt in",
        "z": "5cb619a7.cb38e8",
        "g": "52e9d8db.6bfb78",
        "name": "pause",
        "topic": "hermes/intent/ProKNX:pause",
        "qos": "2",
        "datatype": "auto",
        "broker": "6300ac18.111804",
        "x": 240,
        "y": 910,
        "wires": [
            [
                "4d4583ac.a74c9c"
            ]
        ]
    },
    {
        "id": "cbd5ea7b.864938",
        "type": "mqtt in",
        "z": "5cb619a7.cb38e8",
        "g": "52e9d8db.6bfb78",
        "name": "hermes/asr/textCaptured",
        "topic": "hermes/asr/textCaptured",
        "qos": "2",
        "datatype": "auto",
        "broker": "6300ac18.111804",
        "x": 300,
        "y": 1030,
        "wires": [
            [
                "c751be83.bbd65"
            ]
        ]
    },
    {
        "id": "4d4583ac.a74c9c",
        "type": "function",
        "z": "5cb619a7.cb38e8",
        "g": "52e9d8db.6bfb78",
        "name": "Pause",
        "func": "\nfunction findObjectByKey(array, key, value) {\n\titems = [];\n\tvar cpt = 0;\n\tfor (var i = 0; i < array.length; i++) {\n\t\tif (array[i][key] === value) {\n\t\t\titems[cpt] = array[i];\n\t\t\tcpt++;\n\t\t}\n\t}\n\tif (items[0] !== undefined) {\n\t\treturn items;\n\t} else {\n\t\treturn null;\n\t}\n}\n\nvar lang = global.get(\"msgLang\");\nvar defaultSpeaker = global.get(\"defaultSpeaker\");\nvar tvFavorites = global.get(\"tvFavorites\");\nvar siteIdTv = global.get(\"siteIdTv\");\nif(defaultSpeaker === undefined){\n    defaultSpeaker = \"speaker\";\n}\nmsg.cmd={};\nmsg.payload = JSON.parse(msg.payload);\nmsg.cmd.siteId = msg.payload.siteId.replace(/_\\d+$/, \"\").trim();\nvar doAllRooms = false;\nvar intent = msg.payload.intent.intentName;\nif (intent === undefined) \n    return null;\n\nvar rawRoom = findObjectByKey(msg.payload.slots, 'slotName', 'room');\nvar rawFavorite = findObjectByKey(msg.payload.slots, 'entity', 'FavoriteType');\nvar rawSpeaker = findObjectByKey(msg.payload.slots, 'entity', 'SpeakerType');\n\n//node.warn(msg.payload);\n//node.warn(\"rawRoom: \"+ JSON.stringify(rawRoom) );\nvar theRoom = msg.payload.siteId;\n\nif (rawRoom !== null) {\n\tmsg.cmd.room = [];\n\tfor (var i = 0; i < rawRoom.length; i++) {\n\t\tmsg.cmd.room[i] = rawRoom[i].value.value.toLowerCase();\n\t\t//node.warn(\"msg.cmd.room[i]: \"+msg.cmd.room[i] + \"   msg.payload.siteId: \"+msg.payload.siteId);\n\t\tif (msg.cmd.room[i] === \"here\" || msg.cmd.room[i] === \"hier\" || msg.cmd.room[i] === \"ici\") {\n\t\t\ttheRoom = msg.payload.siteId;\n\t\t} else {\n    \t\tif (msg.cmd.room[i] === \"all\" || msg.cmd.room[i] === \"everywhere\" || msg.cmd.room[i] === \"ueberall\" || msg.cmd.room[i] === \"partout\") {\n    \t\t    doAllRooms = true;\n    \t\t} else {\n    \t\t    theRoom = msg.cmd.room[i].replace(/ /g, \"_\");\n    \t\t}\n\t\t}\n\t}\n}\n\nif (rawSpeaker !== null) {\n    //node.warn(\"rawSpeaker: \"+JSON.stringify(rawSpeaker));\n    msg.payload.speaker = rawSpeaker[0].value.value.trim().toLowerCase();\n} else {\n    msg.payload.speaker = defaultSpeaker.trim().toLowerCase();\n}\n\nmsg.payload.siteId = theRoom;\n\nif(msg.payload.siteId.toLowerCase().replace(/_\\d+$/,\"\").replace(/_/g,\"\") !== siteIdTv.toLowerCase().replace(/_\\d+$/,\"\").replace(/ /g,\"\")){\n    return null;\n}\n\n//node.warn(\" Will use msg.payload.siteId: \"+msg.payload.siteId);\n//global.set(\"siteIdTv\", msg.payload.siteId);\n\nif (rawFavorite !== null) {\n    //node.warn(\"rawFavorite: \"+JSON.stringify(rawFavorite));\n    msg.payload.favorite = rawFavorite[0].value.value.trim().toLowerCase();\n}\n\n//var msgFavorite = msg;\nvar sonosPlaylists = global.get(\"sonosPlaylists\");\nvar sonosFavorites = global.get(\"sonosFavorites\");  \n\nif(msg.payload.favorite !== undefined){\n\n    var searchItem = msg.payload.favorite;\n    //node.warn(\"searchItem : \"+searchItem);\n    \n    var found1 = sonosPlaylists.find(\n        function(str) { return str.toLowerCase() == searchItem.toLowerCase(); }\n        );\n    \n    var found2 = sonosFavorites.find(\n            function(str) { return str.toLowerCase() == searchItem.toLowerCase(); }\n        );\n    \n    if(found1 !== undefined || found2 !== undefined){\n        return null;\n    }\n}\n\n//node.warn(\"msg.payload.speaker: \"+msg.payload.speaker);\n    \nif (msg.payload.intent.confidenceScore < 0.6 || msg.payload.asrTokens!== undefined && msg.payload.asrTokens[0].length <= 1){\n    return null;\n}\n\nvar messageTv = flow.get(\"messageTv\");\n\nif(msg.payload.speaker === \"tv\" ){\n    \n    global.set(\"defaultSpeaker\", \"tv\");\n    \n    if(messageTv === \"off\"){\n        return [null, msg];\n    }else{\n        return [msg, null];\n    }\n\n}\n",
        "outputs": 2,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "x": 380,
        "y": 910,
        "wires": [
            [
                "fea35ab3.fc3218"
            ],
            [
                "7c349373.7372ac"
            ]
        ]
    },
    {
        "id": "c751be83.bbd65",
        "type": "function",
        "z": "5cb619a7.cb38e8",
        "g": "52e9d8db.6bfb78",
        "name": "Filter",
        "func": "msg.payload = JSON.parse(msg.payload);\nmsg.cmd = {};\nmsg.cmd.lang = global.get(\"msgLang\");\n\nif(msg.cmd.lang === \"de\"){\n    \n    if(msg.payload.text.includes(\"pause\")){\n            \n        flow.set(\"messageTv\", \"off\");\n    }else{\n        flow.set(\"messageTv\", \"on\");\n    }\n    \n    if(msg.payload.text.includes(\"kanal\")){\n        \n        var channel = \"\";\n        \n        for(var i=2; i<msg.payload.tokens.length; i++){\n            channel = channel + msg.payload.tokens[i].value;\n        }\n        \n        flow.set(\"channelNumber\", channel);\n        flow.set(\"setScreen\", \"channel\");\n        global.set(\"defaultSpeaker\", \"tv\");\n        \n    }else{\n        flow.set(\"setScreen\", \"media\");\n        flow.set(\"channelNumber\", \"\");\n    }\n    \n    \n        \n    \n} else if(msg.cmd.lang === \"fr\"){\n    \n    if(msg.payload.text.includes(\"pause\")){\n            \n            flow.set(\"messageTv\", \"off\");\n            \n    }else{\n        flow.set(\"messageTv\", \"on\");\n    }\n    \n    if(msg.payload.text.includes(\"canal\")){\n        \n        var channel = \"\";\n        \n        for(var i=2; i<msg.payload.tokens.length; i++){\n            channel = channel + msg.payload.tokens[i].value;\n        }\n        \n        flow.set(\"channelNumber\", channel);\n        flow.set(\"setScreen\", \"channel\");\n        global.set(\"defaultSpeaker\", \"tv\");\n        \n    }else{\n        flow.set(\"setScreen\", \"media\");\n        flow.set(\"channelNumber\", \"\");\n    }\n    \n}else{\n    \n    if(msg.payload.text.includes(\"pause\")){\n            \n        flow.set(\"messageTv\", \"off\");\n            \n    }else{\n        flow.set(\"messageTv\", \"on\");\n    }\n    \n    if(msg.payload.text.includes(\"channel\")){\n        \n        var channel = \"\";\n        \n        for(var i=2; i<msg.payload.tokens.length; i++){\n            channel = channel + msg.payload.tokens[i].value;\n        }\n        \n        flow.set(\"channelNumber\", channel);\n        flow.set(\"setScreen\", \"channel\");\n        global.set(\"defaultSpeaker\", \"tv\");\n        \n    }else{\n        flow.set(\"setScreen\", \"media\");\n        flow.set(\"channelNumber\", \"\");\n    }\n}\n",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "x": 490,
        "y": 1030,
        "wires": [
            []
        ]
    },
    {
        "id": "94dd563d.fd7ef8",
        "type": "bravia-api",
        "z": "5cb619a7.cb38e8",
        "g": "52e9d8db.6bfb78",
        "tv": "204aae5a.40fb72",
        "method": "audio:1.2:setAudioVolume",
        "payload": "{\"target\":\"speaker\", \"volume\":\"+6\"}",
        "name": "Volume up",
        "x": 720,
        "y": 1270,
        "wires": [
            []
        ]
    },
    {
        "id": "251146ee.15fe1a",
        "type": "bravia-api",
        "z": "5cb619a7.cb38e8",
        "g": "52e9d8db.6bfb78",
        "tv": "204aae5a.40fb72",
        "method": "audio:1.2:setAudioVolume",
        "payload": "{\"target\":\"speaker\", \"volume\":\"-6\"}",
        "name": "Volume down",
        "x": 710,
        "y": 1330,
        "wires": [
            []
        ]
    },
    {
        "id": "f6e0c68e.623c98",
        "type": "bravia-api",
        "z": "5cb619a7.cb38e8",
        "g": "52e9d8db.6bfb78",
        "tv": "204aae5a.40fb72",
        "method": "system:1.0:setPowerStatus",
        "payload": "{\"status\":true}",
        "name": "Power on",
        "x": 760,
        "y": 560,
        "wires": [
            []
        ]
    },
    {
        "id": "2d2bd1fe.8744de",
        "type": "bravia-api",
        "z": "5cb619a7.cb38e8",
        "g": "52e9d8db.6bfb78",
        "tv": "204aae5a.40fb72",
        "method": "system:1.0:getPowerStatus",
        "payload": "",
        "name": "TV status",
        "x": 555,
        "y": 580,
        "wires": [
            [
                "5cc2d10e.b6945"
            ]
        ],
        "l": false
    },
    {
        "id": "5cc2d10e.b6945",
        "type": "switch",
        "z": "5cb619a7.cb38e8",
        "g": "52e9d8db.6bfb78",
        "name": "Is TV On?",
        "property": "payload.status",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "standby",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "active",
                "vt": "str"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 615,
        "y": 580,
        "wires": [
            [
                "f6e0c68e.623c98"
            ],
            [
                "8c3735fc.2fe498"
            ]
        ],
        "l": false
    },
    {
        "id": "8c3735fc.2fe498",
        "type": "bravia-ircc",
        "z": "5cb619a7.cb38e8",
        "g": "52e9d8db.6bfb78",
        "tv": "204aae5a.40fb72",
        "ircc": "Confirm",
        "name": "Play",
        "x": 770,
        "y": 600,
        "wires": []
    },
    {
        "id": "69b9e773.2f1dc8",
        "type": "bravia-api",
        "z": "5cb619a7.cb38e8",
        "g": "52e9d8db.6bfb78",
        "tv": "204aae5a.40fb72",
        "method": "audio:1.0:setAudioMute",
        "payload": "{\"status\":true}",
        "name": "Mute",
        "x": 730,
        "y": 441,
        "wires": [
            []
        ]
    },
    {
        "id": "215c6f8a.84434",
        "type": "bravia-api",
        "z": "5cb619a7.cb38e8",
        "g": "52e9d8db.6bfb78",
        "tv": "204aae5a.40fb72",
        "method": "audio:1.0:setAudioMute",
        "payload": "{\"status\":false}",
        "name": "Unmute",
        "x": 740,
        "y": 489,
        "wires": [
            []
        ]
    },
    {
        "id": "c682251d.089108",
        "type": "bravia-api",
        "z": "5cb619a7.cb38e8",
        "g": "52e9d8db.6bfb78",
        "tv": "204aae5a.40fb72",
        "method": "audio:1.2:setAudioVolume",
        "payload": "",
        "name": "Set volume",
        "x": 869,
        "y": 1390,
        "wires": [
            []
        ]
    },
    {
        "id": "494ba95d.e1d478",
        "type": "bravia-api",
        "z": "5cb619a7.cb38e8",
        "g": "52e9d8db.6bfb78",
        "tv": "204aae5a.40fb72",
        "method": "audio:1.0:setAudioMute",
        "payload": "{\"status\":false}",
        "name": "Unmute",
        "x": 540,
        "y": 1270.6000061035156,
        "wires": [
            [
                "94dd563d.fd7ef8"
            ]
        ]
    },
    {
        "id": "ee15cac3.c9ed18",
        "type": "bravia-api",
        "z": "5cb619a7.cb38e8",
        "g": "52e9d8db.6bfb78",
        "tv": "204aae5a.40fb72",
        "method": "audio:1.0:setAudioMute",
        "payload": "{\"status\":false}",
        "name": "Unmute",
        "x": 539,
        "y": 1330,
        "wires": [
            [
                "251146ee.15fe1a"
            ]
        ]
    },
    {
        "id": "fea35ab3.fc3218",
        "type": "bravia-api",
        "z": "5cb619a7.cb38e8",
        "g": "52e9d8db.6bfb78",
        "tv": "204aae5a.40fb72",
        "method": "system:1.0:setPowerStatus",
        "payload": "{\"status\":false}",
        "name": "Power off",
        "x": 536,
        "y": 882,
        "wires": [
            []
        ]
    },
    {
        "id": "c3949da6.8076c",
        "type": "bravia-api",
        "z": "5cb619a7.cb38e8",
        "g": "52e9d8db.6bfb78",
        "tv": "204aae5a.40fb72",
        "method": "audio:1.0:setAudioMute",
        "payload": "{\"status\":false}",
        "name": "Unmute",
        "x": 399,
        "y": 1390,
        "wires": [
            [
                "d512befb.eee86"
            ]
        ]
    },
    {
        "id": "6b678aad.353e94",
        "type": "function",
        "z": "5cb619a7.cb38e8",
        "g": "52e9d8db.6bfb78",
        "name": "Set volume",
        "func": "const minLoudness = msg.payload[0].minVolume;\nconst maxLoudness = msg.payload[0].maxVolume;\nvar rawLoudness = flow.get(\"rawLoudness\");\nvar rawMin = flow.get(\"rawMin\");\nvar rawMax = flow.get(\"rawMax\");\nvar loudness = 1;\nvar nbrLoudness = '1';\n\n\nif(rawLoudness!==null){\n    loudness = rawLoudness[0].value.value;\n    nbrLoudness = Number(loudness);\n    if(loudness === undefined || rawLoudness[0].value.kind !== 'Number' || isNaN(nbrLoudness) === true){\n        node.warn(\"Skipping invalid volume\");\n        return;\n    }\n}\nif(rawMax!==null){\n    loudness = maxLoudness;\n}\nif(rawMin!==null){\n    loudness = minLoudness;\n}\nif(nbrLoudness>Number(maxLoudness)){\n    loudness = maxLoudness;\n}\n\nif(nbrLoudness<Number(minLoudness)){\n    loudness = minLoudness;    \n}\n\nloudness = String(loudness);\n\nmsg.payload = {\"target\":\"speaker\",\"volume\":loudness};\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "x": 709,
        "y": 1390,
        "wires": [
            [
                "c682251d.089108"
            ]
        ]
    },
    {
        "id": "d512befb.eee86",
        "type": "bravia-api",
        "z": "5cb619a7.cb38e8",
        "g": "52e9d8db.6bfb78",
        "tv": "204aae5a.40fb72",
        "method": "audio:1.0:getVolumeInformation",
        "payload": "",
        "name": "Volume info",
        "x": 549,
        "y": 1390,
        "wires": [
            [
                "6b678aad.353e94"
            ]
        ]
    },
    {
        "id": "afefc423.856f28",
        "type": "bravia-api",
        "z": "5cb619a7.cb38e8",
        "g": "52e9d8db.6bfb78",
        "tv": "204aae5a.40fb72",
        "method": "appControl:1.0:getApplicationList",
        "payload": "",
        "name": "App List",
        "x": 320,
        "y": 1470,
        "wires": [
            [
                "976516bc.24a0a8"
            ]
        ]
    },
    {
        "id": "3f370e8c.555af2",
        "type": "inject",
        "z": "5cb619a7.cb38e8",
        "g": "52e9d8db.6bfb78",
        "name": "",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": true,
        "onceDelay": "3",
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "x": 200,
        "y": 1490,
        "wires": [
            [
                "afefc423.856f28",
                "bcfcf268.3fe4d"
            ]
        ],
        "l": false
    },
    {
        "id": "4694b7ad.51d608",
        "type": "function",
        "z": "5cb619a7.cb38e8",
        "g": "52e9d8db.6bfb78",
        "name": "TvList",
        "func": "function findObjectByKey(array, key, value) {\n\titems = [];\n\tvar cpt = 0;\n\tfor (var i = 0; i < array.length; i++) {\n\t\tif (array[i][key].toLowerCase() === value.toLowerCase()) {\n\t\t\titems[cpt] = array[i];\n\t\t\tcpt++;\n\t\t}\n\t}\n\tif (items[0] !== undefined) {\n\t\treturn items;\n\t} else {\n\t\treturn null;\n\t}\n}\n\nvar setScreen = flow.get(\"setScreen\");\nvar appListURI = global.get(\"appListURI\");\nvar channelListURI = global.get(\"channelListURI\");\n//msg.payload = JSON.parse(msg.payload);\nvar find = global.get(\"msg.payload.favorite\");\n\nvar found1 = findObjectByKey(appListURI, \"title\", find);\nvar found2 = findObjectByKey(channelListURI, \"title\", find);\n\nif(found1 !== null){\n    msg.payload = \"{\\\"uri\\\":\\\"\" + found1[0].uri + \"\\\"}\";\n    return [msg, null, null];\n    \n}\n\nif(found2 !== null){\n    \n    msg.payload = \"{\\\"uri\\\":\\\"\" + found2[0].uri + \"\\\"}\";\n    return [null, msg, null];\n}\n\nif(found1 === null && found2 === null){\n    return [null, null, msg];\n    \n}\n",
        "outputs": 3,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "x": 290,
        "y": 770,
        "wires": [
            [
                "2d7cd6aa.9129ba"
            ],
            [
                "581b1e84.8ed8f"
            ],
            [
                "e5a3404.6a8d4c"
            ]
        ]
    },
    {
        "id": "2d7cd6aa.9129ba",
        "type": "bravia-api",
        "z": "5cb619a7.cb38e8",
        "g": "52e9d8db.6bfb78",
        "tv": "204aae5a.40fb72",
        "method": "appControl:1.0:setActiveApp",
        "payload": "",
        "name": "setActiveApp",
        "x": 470,
        "y": 730,
        "wires": [
            []
        ]
    },
    {
        "id": "229a9693.c2ea3a",
        "type": "bravia-api",
        "z": "5cb619a7.cb38e8",
        "g": "52e9d8db.6bfb78",
        "tv": "204aae5a.40fb72",
        "method": "system:1.0:setPowerStatus",
        "payload": "{\"status\":true}",
        "name": "Power on",
        "x": 675,
        "y": 660,
        "wires": [
            [
                "8e95504b.0ad05"
            ]
        ],
        "l": false
    },
    {
        "id": "e5a3404.6a8d4c",
        "type": "bravia-api",
        "z": "5cb619a7.cb38e8",
        "g": "52e9d8db.6bfb78",
        "tv": "204aae5a.40fb72",
        "method": "appControl:1.0:terminateApps",
        "payload": "",
        "name": "Terminate App",
        "x": 480,
        "y": 810,
        "wires": [
            [
                "1479cb72.1f5455"
            ]
        ]
    },
    {
        "id": "8a657f4d.c131f",
        "type": "switch",
        "z": "5cb619a7.cb38e8",
        "g": "52e9d8db.6bfb78",
        "name": "Is TV On?",
        "property": "payload.status",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "standby",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "active",
                "vt": "str"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 615,
        "y": 670,
        "wires": [
            [
                "229a9693.c2ea3a"
            ],
            [
                "4694b7ad.51d608"
            ]
        ],
        "l": false
    },
    {
        "id": "92f0422e.0ba67",
        "type": "bravia-api",
        "z": "5cb619a7.cb38e8",
        "g": "52e9d8db.6bfb78",
        "tv": "204aae5a.40fb72",
        "method": "system:1.0:getPowerStatus",
        "payload": "",
        "name": "TV status",
        "x": 555,
        "y": 670,
        "wires": [
            [
                "8a657f4d.c131f"
            ]
        ],
        "l": false
    },
    {
        "id": "13d3fa17.79c236",
        "type": "function",
        "z": "5cb619a7.cb38e8",
        "g": "52e9d8db.6bfb78",
        "name": "",
        "func": "//set siteIdTv\n\nvar siteIdTv = msg.payload;\n\nString.prototype.sansAccent = function() {\n    var accent = [\n        /[\\300-\\306]/g, /[\\340-\\346]/g, // A, a\n        /[\\310-\\313]/g, /[\\350-\\353]/g, // E, e\n        /[\\314-\\317]/g, /[\\354-\\357]/g, // I, i\n        /[\\322-\\330]/g, /[\\362-\\370]/g, // O, o\n        /[\\331-\\334]/g, /[\\371-\\374]/g, // U, u\n        /[\\321]/g, /[\\361]/g, // N, n\n        /[\\307]/g, /[\\347]/g, // C, c\n    ];\n    var noaccent = ['A','a','E','e','I','i','O','o','U','u','N','n','C','c'];\n         \n    var str = this;\n    for(var i = 0; i < accent.length; i++){\n        str = str.replace(\"ä\", \"ae\");\n        str = str.replace(\"ü\", \"ue\");\n        str = str.replace(\"ö\", \"oe\");        \n        str = str.replace(accent[i], noaccent[i]);\n    }\n    return str;\n};\n\n\nglobal.set(\"siteIdTv\", siteIdTv.sansAccent()); \n",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "x": 490,
        "y": 165,
        "wires": [
            []
        ],
        "l": false
    },
    {
        "id": "9755ec2d.54d31",
        "type": "inject",
        "z": "5cb619a7.cb38e8",
        "g": "52e9d8db.6bfb78",
        "name": "Set the TV room here !",
        "props": [
            {
                "p": "payload"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": true,
        "onceDelay": "1",
        "topic": "",
        "payload": "Living room",
        "payloadType": "str",
        "x": 300,
        "y": 165,
        "wires": [
            [
                "13d3fa17.79c236"
            ]
        ]
    },
    {
        "id": "369f6164.fbcb0e",
        "type": "function",
        "z": "5cb619a7.cb38e8",
        "g": "52e9d8db.6bfb78",
        "name": "GET /siteIdTv ",
        "func": "var siteIdTv = global.get(\"siteIdTv\");\n\nif(msg.payload.siteId.toLowerCase().replace(/_\\d+$/,\"\").replace(/_/g,\"\") !== siteIdTv.toLowerCase().replace(/_\\d+$/,\"\").replace(/ /g,\"\")){\n    return null;\n}else{\n    return msg;\n}\n\n",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "x": 475,
        "y": 441,
        "wires": [
            [
                "31f9f0fa.456cc"
            ]
        ],
        "l": false
    },
    {
        "id": "b846b833.608468",
        "type": "function",
        "z": "5cb619a7.cb38e8",
        "g": "52e9d8db.6bfb78",
        "name": "GET /siteIdTv ",
        "func": "var siteIdTv = global.get(\"siteIdTv\");\n\nif(msg.payload.siteId.toLowerCase().replace(/_\\d+$/,\"\").replace(/_/g,\"\") !== siteIdTv.toLowerCase().replace(/_\\d+$/,\"\").replace(/ /g,\"\")){\n    return null;\n}else{\n    return msg;\n}\n",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "x": 435,
        "y": 490,
        "wires": [
            [
                "7fbbe3df.06898c"
            ]
        ],
        "l": false
    },
    {
        "id": "ec431cc5.48c28",
        "type": "comment",
        "z": "5cb619a7.cb38e8",
        "g": "52e9d8db.6bfb78",
        "name": "IMPORTANT Manually set the siteIdTv  IMPORTANT ",
        "info": "It is strongly recommended to set a valid siteId for the TV (siteIdTv), the place where you place your TV. (eg: bedroom, office, living room)\n\nThe siteIdTv's must be an existing room from your installation see PRATGLAD or Aragon application. (e.g PRATGLAD's user interface -> Configure -> no. 3 -> Settings -> Rooms)",
        "x": 376,
        "y": 120,
        "wires": []
    },
    {
        "id": "a10179ea.68ecc8",
        "type": "switch",
        "z": "5cb619a7.cb38e8",
        "g": "52e9d8db.6bfb78",
        "name": "Is TV On?",
        "property": "payload.status",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "standby",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "active",
                "vt": "str"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 615,
        "y": 441,
        "wires": [
            [],
            [
                "69b9e773.2f1dc8"
            ]
        ],
        "l": false
    },
    {
        "id": "31f9f0fa.456cc",
        "type": "bravia-api",
        "z": "5cb619a7.cb38e8",
        "g": "52e9d8db.6bfb78",
        "tv": "204aae5a.40fb72",
        "method": "system:1.0:getPowerStatus",
        "payload": "",
        "name": "TV status",
        "x": 555,
        "y": 441,
        "wires": [
            [
                "a10179ea.68ecc8"
            ]
        ],
        "l": false
    },
    {
        "id": "7fbbe3df.06898c",
        "type": "bravia-api",
        "z": "5cb619a7.cb38e8",
        "g": "52e9d8db.6bfb78",
        "tv": "204aae5a.40fb72",
        "method": "system:1.0:getPowerStatus",
        "payload": "",
        "name": "TV status",
        "x": 535,
        "y": 490,
        "wires": [
            [
                "aef45fc1.bde35"
            ]
        ],
        "l": false
    },
    {
        "id": "aef45fc1.bde35",
        "type": "switch",
        "z": "5cb619a7.cb38e8",
        "g": "52e9d8db.6bfb78",
        "name": "Is TV On?",
        "property": "payload.status",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "standby",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "active",
                "vt": "str"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 615,
        "y": 490,
        "wires": [
            [],
            [
                "215c6f8a.84434"
            ]
        ],
        "l": false
    },
    {
        "id": "7c349373.7372ac",
        "type": "bravia-ircc",
        "z": "5cb619a7.cb38e8",
        "g": "52e9d8db.6bfb78",
        "tv": "204aae5a.40fb72",
        "ircc": "Pause",
        "name": "Pause",
        "x": 531,
        "y": 950,
        "wires": []
    },
    {
        "id": "ece67af.450e188",
        "type": "comment",
        "z": "5cb619a7.cb38e8",
        "g": "52e9d8db.6bfb78",
        "name": "IMPORTANT Define the TV Favorites here IMPORTANT ",
        "info": "",
        "x": 385,
        "y": 210,
        "wires": []
    },
    {
        "id": "64b9142d.22f9fc",
        "type": "comment",
        "z": "5cb619a7.cb38e8",
        "g": "52e9d8db.6bfb78",
        "name": "DEBUG Sony Bravia",
        "info": "",
        "x": 755,
        "y": 130,
        "wires": []
    },
    {
        "id": "972c3bfb.1fce78",
        "type": "function",
        "z": "5cb619a7.cb38e8",
        "g": "52e9d8db.6bfb78",
        "name": "Filter",
        "func": "// to filter which type of media ; channel or video?\n\nvar setScreen = flow.get(\"setScreen\");\n\n    if(setScreen === \"channel\"){\n        return [msg, null];\n    }else{\n        return [null, msg];\n    }",
        "outputs": 2,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "x": 545,
        "y": 1105,
        "wires": [
            [
                "10bd7bc7.3f9e74"
            ],
            [
                "f13e1d86.be0f5"
            ]
        ]
    },
    {
        "id": "10bd7bc7.3f9e74",
        "type": "bravia-ircc",
        "z": "5cb619a7.cb38e8",
        "g": "52e9d8db.6bfb78",
        "tv": "204aae5a.40fb72",
        "ircc": "ChannelUp",
        "name": "Channel Up",
        "x": 704,
        "y": 1090,
        "wires": []
    },
    {
        "id": "9827803f.d4e01",
        "type": "bravia-ircc",
        "z": "5cb619a7.cb38e8",
        "g": "52e9d8db.6bfb78",
        "tv": "204aae5a.40fb72",
        "ircc": "ChannelDown",
        "name": "Channel Down",
        "x": 714,
        "y": 1170,
        "wires": []
    },
    {
        "id": "17254540.68d00b",
        "type": "function",
        "z": "5cb619a7.cb38e8",
        "g": "52e9d8db.6bfb78",
        "name": "Filter",
        "func": "// to filter which type of media ; channel or video?\n\nvar setScreen = flow.get(\"setScreen\");\n\n    if(setScreen === \"channel\"){\n        return [msg, null];\n    }else{\n        return [null, msg];\n    }",
        "outputs": 2,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "x": 545,
        "y": 1185,
        "wires": [
            [
                "9827803f.d4e01"
            ],
            [
                "31b81f39.5b4fd"
            ]
        ]
    },
    {
        "id": "bcfcf268.3fe4d",
        "type": "bravia-api",
        "z": "5cb619a7.cb38e8",
        "g": "52e9d8db.6bfb78",
        "tv": "204aae5a.40fb72",
        "method": "avContent:1.0:getContentList",
        "payload": "{\"source\":\"tv:dvbt\", \"stIdx\":0, \"cnt\":100, \"type\":\"string\"}",
        "name": "TV DVBT Content List",
        "x": 360,
        "y": 1510,
        "wires": [
            [
                "3b856c89.20b7e4"
            ]
        ]
    },
    {
        "id": "8e95504b.0ad05",
        "type": "delay",
        "z": "5cb619a7.cb38e8",
        "g": "52e9d8db.6bfb78",
        "name": "",
        "pauseType": "delay",
        "timeout": "5",
        "timeoutUnits": "seconds",
        "rate": "1",
        "nbRateUnits": "1",
        "rateUnits": "second",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": false,
        "x": 725,
        "y": 660,
        "wires": [
            [
                "4694b7ad.51d608"
            ]
        ],
        "l": false
    },
    {
        "id": "f13e1d86.be0f5",
        "type": "bravia-ircc",
        "z": "5cb619a7.cb38e8",
        "g": "52e9d8db.6bfb78",
        "tv": "204aae5a.40fb72",
        "ircc": "Next",
        "name": "Next",
        "x": 685,
        "y": 1125,
        "wires": []
    },
    {
        "id": "3b856c89.20b7e4",
        "type": "function",
        "z": "5cb619a7.cb38e8",
        "g": "52e9d8db.6bfb78",
        "name": "Filter",
        "func": "var lang = global.get(\"msgLang\");\n\nString.prototype.replaceDigitsWithNumbers = function(){\n    \n    if(lang == \"de\"){\n        \n        var number = [\"Neunundneunzig\",\"Neunundachtzig\",\"Neunundsiebzig\",\"Neunundsechzig\",\"Neunundfünfzig\",\"Neunundvierzig\",\"Neununddreiβig\",\"Neunundzwanzig\",\"Neunzehn\",\n            \"Achtundneunzig\",\"Achtundachtzig\",\"Achtundsiebzig\",\"Achtundsechzig\",\"Achtundfünfzig\",\"Achtundvierzig\",\"Achtunddreiβig\",\"Achtundzwanzig\",\"Achtzehn\",\n            \"Siebenundneunzig\",\"Siebenundachtzig\",\"Siebenundsiebzig\",\"Siebenundsechzig\",\"Siebenundfünfzig\",\"Siebenundvierzig\",\"Siebenunddreiβig\",\"Siebenundzwanzig\",\"Siebzehn\",\n            \"Sechsundneunzig\",\"Sechsundachtzig\",\"Sechsundsiebzig\",\"Sechsundsechzig\",\"Sechsundfünfzig\",\"Sechsundvierzig\",\"Sechsunddreiβig\",\"Sechsundzwanzig\",\"Sechzehn\",\n            \"Fünfundneunzig\",\"Fünfundachtzig\",\"Fünfundsiebzig\",\"Fünfundsechzig\",\"Fünfundfünfzig\",\"Fünfundvierzig\",\"Fünfunddreiβig\",\"Fünfundzwanzig\",\"Fünfzehn\",\n            \"Vierundneunzig\",\"Vierundachtzig\",\"Vierundsiebzig\",\"Vierundsechzig\",\"Vierundfünfzig\",\"Vierundvierzig\",\"Vierunddreiβig\",\"Vierundzwanzig\",\"Vierzehn\",\n            \"Dreiundneunzig\",\"Dreiundachtzig\",\"Dreiundsiebzig\",\"Dreiundsechzig\",\"Dreiundfünfzig\",\"Dreiundvierzig\",\"Dreiunddreiβig\",\"Dreiundzwanzig\",\"Dreizehn\",\n            \"Zweiundneunzig\",\"Zweiundachtzig\",\"Zweiundsiebzig\",\"Zweiundsechzig\",\"Zweiundfünfzig\",\"Zweiundvierzig\",\"Zweiunddreiβig\",\"Zweiundzwanzig\",\"Zwölf\",\n            \"Einundneunzig\",\"Einundachtzig\",\"Einundsiebzig\",\"Einundsechzig\",\"Einundfünfzig\",\"Einundvierzig\",\"Einunddreiβig\",\"Einundzwanzig\",\"Elf\",\n            \"Einhundert\",\"Neunzig\",\"Achtzig\",\"Siebzig\",\"Sechzig\",\"Fünfzig\",\"Vierzig\",\"Dreiβig\",\"Zwanzig\",\"Zehn\",\"Neun\",\"Acht\",\"Sieben\",\"Sechs\",\"Fünf\",\"Vier\",\"Drei\",\"Zwei\",\"Eins\"\n        ];\n\n        \n    }else if(lang == \"fr\"){\n        \n        var number = [\"Quatre-vingt-dix-neuf\",\"Quatre-vingt-neuf\",\"Soixante-dix-neuf \",\"Soixante-neuf\",\"Cinquante-neuf\",\"Quarante-neuf\",\" Trente-neuf \",\" Vingt-neuf \",\"Dix-neuf\",\n            \"Quatre-vingt-dix-huit\",\"Quatre-vingt-huit\", \"Soixante-dix-huit\",\" Soixante-huit\",\"Cinquante-huit\",\"Quarante-huit\",\"Trente-huit\",\"Vingt-huit\",\"Dix-huit\",\n            \"Quatre-vingt-dix-sept\",\"Quatre-vingt-sept\",\"Soixante-dix-sept\",\"Soixante-sept\",\"Cinquante-sept\",\"Quarante-sept\",\"Trente-sept\",\"Vingt-sept\",\"Dix-sept\",\n            \"Quatre-vingt-seize\",\"Quatre-vingt-six\",\"Soixante-six\",\"Soixante-six\",\"Cinquante-six\",\"Quarante-six\",\"Trente-six\",\"Vingt-six\",\"Seize\",\n            \"Quatre-vingt-quinze\",\"Quatre-vingt-cinq\",\"Soixante-quinze\",\"Soixante-cinq\",\"Cinquante-cinq\",\"Quarante-cinq\",\"Trente-cinq\",\"Vingt-cinq\",\"Quinze\",\n            \"Quatre-vingt-quatorze\",\"Quatre-vingt-quatre\",\"Soixante-quatorze\",\"Soixante-quatre\",\"Cinquante-quatre\",\"Quarante-quatre\",\"Trente-quatre\",\"Vingt-quatre\",\"Quatorze\",\n            \"Quatre-vingt-treize\",\"Quatre-vingt-trois\",\"Soixante-treize\",\"Soixante-trois\",\"Cinquante-trois\",\"Quarante-trois\",\"Trente-trois\",\"Vingt-trois\",\"Treize\",\n            \"Quatre-vingt-douze\",\"Quatre-vingt-deux\",\"Soixante-douze\",\"Soixante-deux\",\"Cinquante-deux\",\"Quarante-deux\",\"Trente-deux\",\"Vingt-deux\",\"Douze\",\n            \"Quatre-vingt-onze\",\"Quatre-vingt-un\",\"Soixante et onze\",\"Soixante et un\",\"Cinquante et un\",\"Quarante et un\",\"Trente et un\",\"Vingt et un\",\"Onze\",\n            \"Cent\",\"Quatre-vingt-dix\",\"Quatre-vingt\",\"Soixante-dix\",\"Soixante\",\"Cinquante\",\"Quarante\",\"Trente\",\"Vingt\",\"Dix\",\n            \"Neuf\",\"Huit\",\"Sept\",\"Six\",\"Cinq\",\"Quatre\",\"Trois\",\"Deux\",\"Un\"\n        ];\n        \n    }else{\n        \n        var number = [\"Ninety-nine\",\"Eighty-nine\",\"Seventy-nine\",\"Sixty-nine\",\"Fifty-nine\",\"Forty-nine\",\"Thirty-nine\",\"Twenty-nine\",\"Nineteen\",\n            \"Ninety-eight\",\"Eighty-eight\",\"Seventy-eight\",\"Sixty-eight\",\"Fifty-eight\",\"Forty-eight\",\"Thirty-eight\",\"Twenty-eight\",\"Eighteen\",\n            \"Ninety-seven\",\"Eighty-seven\",\"Seventy-seven\",\"Sixty-seven\",\"Fifty-seven\",\"Forty-seven\",\"Thirty-seven\",\"Twenty-seven\",\"Seventeen\",\n            \"Ninety-six\",\"Eighty-six\",\"Seventy-six\",\"Sixty-six\",\"Fifty-six\",\"Forty-six\",\"Thirty-six\",\"Twenty-six\",\"Sixteen\",\n            \"Ninety-five\",\"Eighty-five\",\"Seventy-five\",\"Sixty-five\",\"Fifty-five\",\"Forty-five\",\"Thirty-five\",\"Twenty-five\",\"Fifteen\",\n            \"Ninety-four\",\"Eighty-four\",\"Seventy-four\",\"Sixty-four\",\"Fifty-four\",\"Forty-four\",\"Thirty-four\",\"Twenty-four\",\"Fourteen\",\n            \"Ninety-three\",\"Eighty-three\",\"Seventy-three\",\"Sixty-three\",\"Fifty-three\",\"Forty-three\",\"Thirty-three\",\"Twenty-three\",\"Thirteen\",\n            \"Ninety-two\",\"Eighty-two\",\"Seventy-two\",\"Sixty-two\",\"Fifty-two\",\"Forty-two\",\"Thirty-two\",\"Twenty-two\",\"Twelve\",\n            \"Ninety-one\",\"Eighty-one\",\"Seventy-one\",\"Sixty-one\",\"Fifty-one\",\"Forty-one\",\"Thirty-one\",\"Twenty-one\",\"Eleven\",\n            \"One Hundred\",\"Ninety\",\"Eighty\",\"Seventy\",\"Sixty\",\"Fifty\",\"Forty\",\"Thirty\",\"Twenty\",\"Ten\",\n            \"Nine\",\"Eight\",\"Seven\",\"Six\",\"Five\",\"Four\",\"Three\",\"Two\",\"One\"\n        ];\n        \n    }\n    \n    var digit = [\"99\",\"89\",\"79\",\"69\",\"59\",\"49\",\"39\",\"29\",\"19\",\n        \"98\",\"88\",\"78\",\"68\",\"58\",\"48\",\"38\",\"28\",\"18\",\n        \"97\",\"87\",\"77\",\"67\",\"57\",\"47\",\"37\",\"27\",\"17\",\n        \"96\",\"86\",\"76\",\"66\",\"56\",\"46\",\"36\",\"26\",\"16\",\n        \"95\",\"85\",\"75\",\"65\",\"55\",\"45\",\"35\",\"25\",\"15\",\n        \"94\",\"84\",\"74\",\"64\",\"54\",\"44\",\"34\",\"24\",\"14\",\n        \"93\",\"83\",\"73\",\"63\",\"53\",\"43\",\"33\",\"23\",\"13\",\n        \"92\",\"82\",\"72\",\"62\",\"52\",\"42\",\"32\",\"22\",\"12\",\n        \"91\",\"81\",\"71\",\"61\",\"51\",\"41\",\"31\",\"21\",\"11\",\n        \"100\",\"90\",\"80\",\"70\",\"60\",\"50\",\"40\",\"30\",\"20\",\"10\",\n        \"9\",\"8\",\"7\",\"6\",\"5\",\"4\",\"3\",\"2\",\"1\"\n    ];\n    \n    var str = this;\n    for(var i = 0; i < digit.length; i++){\n        str = str.replace(digit[i], \" \"+number[i]+\" \");\n    }\n     \n    return str;\n}\n\nvar channelList = [];\nvar globalList = [];\n\n// get title and uri\n\nfor(var i=0; i<msg.payload.length; i++){\n    channelList.push({\"title\" : msg.payload[i].title, \"uri\" : msg.payload[i].uri});\n    globalList.push(msg.payload[i].title);\n    \n    if(msg.payload[i].title !== msg.payload[i].title.replaceDigitsWithNumbers()){\n        //append into new array\n        channelList.push({\"title\" : msg.payload[i].title.replaceDigitsWithNumbers(), \"uri\" : msg.payload[i].uri});\n        globalList.push(msg.payload[i].title.replaceDigitsWithNumbers());\n    }\n}\n\nglobal.set(\"channelList\", globalList);\nglobal.set(\"channelListURI\", channelList);\n\nmsg.payload = channelList;\n\nreturn msg;\n",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "x": 505,
        "y": 1510,
        "wires": [
            []
        ],
        "l": false
    },
    {
        "id": "976516bc.24a0a8",
        "type": "function",
        "z": "5cb619a7.cb38e8",
        "g": "52e9d8db.6bfb78",
        "name": "Filter",
        "func": "var lang = global.get(\"msgLang\");\n\nString.prototype.replaceDigitsWithNumbers = function(){\n    \n    if(lang == \"de\"){\n        \n        var number = [\"Neunundneunzig\",\"Neunundachtzig\",\"Neunundsiebzig\",\"Neunundsechzig\",\"Neunundfünfzig\",\"Neunundvierzig\",\"Neununddreiβig\",\"Neunundzwanzig\",\"Neunzehn\",\n            \"Achtundneunzig\",\"Achtundachtzig\",\"Achtundsiebzig\",\"Achtundsechzig\",\"Achtundfünfzig\",\"Achtundvierzig\",\"Achtunddreiβig\",\"Achtundzwanzig\",\"Achtzehn\",\n            \"Siebenundneunzig\",\"Siebenundachtzig\",\"Siebenundsiebzig\",\"Siebenundsechzig\",\"Siebenundfünfzig\",\"Siebenundvierzig\",\"Siebenunddreiβig\",\"Siebenundzwanzig\",\"Siebzehn\",\n            \"Sechsundneunzig\",\"Sechsundachtzig\",\"Sechsundsiebzig\",\"Sechsundsechzig\",\"Sechsundfünfzig\",\"Sechsundvierzig\",\"Sechsunddreiβig\",\"Sechsundzwanzig\",\"Sechzehn\",\n            \"Fünfundneunzig\",\"Fünfundachtzig\",\"Fünfundsiebzig\",\"Fünfundsechzig\",\"Fünfundfünfzig\",\"Fünfundvierzig\",\"Fünfunddreiβig\",\"Fünfundzwanzig\",\"Fünfzehn\",\n            \"Vierundneunzig\",\"Vierundachtzig\",\"Vierundsiebzig\",\"Vierundsechzig\",\"Vierundfünfzig\",\"Vierundvierzig\",\"Vierunddreiβig\",\"Vierundzwanzig\",\"Vierzehn\",\n            \"Dreiundneunzig\",\"Dreiundachtzig\",\"Dreiundsiebzig\",\"Dreiundsechzig\",\"Dreiundfünfzig\",\"Dreiundvierzig\",\"Dreiunddreiβig\",\"Dreiundzwanzig\",\"Dreizehn\",\n            \"Zweiundneunzig\",\"Zweiundachtzig\",\"Zweiundsiebzig\",\"Zweiundsechzig\",\"Zweiundfünfzig\",\"Zweiundvierzig\",\"Zweiunddreiβig\",\"Zweiundzwanzig\",\"Zwölf\",\n            \"Einundneunzig\",\"Einundachtzig\",\"Einundsiebzig\",\"Einundsechzig\",\"Einundfünfzig\",\"Einundvierzig\",\"Einunddreiβig\",\"Einundzwanzig\",\"Elf\",\n            \"Einhundert\",\"Neunzig\",\"Achtzig\",\"Siebzig\",\"Sechzig\",\"Fünfzig\",\"Vierzig\",\"Dreiβig\",\"Zwanzig\",\"Zehn\",\"Neun\",\"Acht\",\"Sieben\",\"Sechs\",\"Fünf\",\"Vier\",\"Drei\",\"Zwei\",\"Eins\"\n        ];\n\n        \n    }else if(lang == \"fr\"){\n        \n        var number = [\"Quatre-vingt-dix-neuf\",\"Quatre-vingt-neuf\",\"Soixante-dix-neuf \",\"Soixante-neuf\",\"Cinquante-neuf\",\"Quarante-neuf\",\" Trente-neuf \",\" Vingt-neuf \",\"Dix-neuf\",\n            \"Quatre-vingt-dix-huit\",\"Quatre-vingt-huit\", \"Soixante-dix-huit\",\" Soixante-huit\",\"Cinquante-huit\",\"Quarante-huit\",\"Trente-huit\",\"Vingt-huit\",\"Dix-huit\",\n            \"Quatre-vingt-dix-sept\",\"Quatre-vingt-sept\",\"Soixante-dix-sept\",\"Soixante-sept\",\"Cinquante-sept\",\"Quarante-sept\",\"Trente-sept\",\"Vingt-sept\",\"Dix-sept\",\n            \"Quatre-vingt-seize\",\"Quatre-vingt-six\",\"Soixante-six\",\"Soixante-six\",\"Cinquante-six\",\"Quarante-six\",\"Trente-six\",\"Vingt-six\",\"Seize\",\n            \"Quatre-vingt-quinze\",\"Quatre-vingt-cinq\",\"Soixante-quinze\",\"Soixante-cinq\",\"Cinquante-cinq\",\"Quarante-cinq\",\"Trente-cinq\",\"Vingt-cinq\",\"Quinze\",\n            \"Quatre-vingt-quatorze\",\"Quatre-vingt-quatre\",\"Soixante-quatorze\",\"Soixante-quatre\",\"Cinquante-quatre\",\"Quarante-quatre\",\"Trente-quatre\",\"Vingt-quatre\",\"Quatorze\",\n            \"Quatre-vingt-treize\",\"Quatre-vingt-trois\",\"Soixante-treize\",\"Soixante-trois\",\"Cinquante-trois\",\"Quarante-trois\",\"Trente-trois\",\"Vingt-trois\",\"Treize\",\n            \"Quatre-vingt-douze\",\"Quatre-vingt-deux\",\"Soixante-douze\",\"Soixante-deux\",\"Cinquante-deux\",\"Quarante-deux\",\"Trente-deux\",\"Vingt-deux\",\"Douze\",\n            \"Quatre-vingt-onze\",\"Quatre-vingt-un\",\"Soixante et onze\",\"Soixante et un\",\"Cinquante et un\",\"Quarante et un\",\"Trente et un\",\"Vingt et un\",\"Onze\",\n            \"Cent\",\"Quatre-vingt-dix\",\"Quatre-vingt\",\"Soixante-dix\",\"Soixante\",\"Cinquante\",\"Quarante\",\"Trente\",\"Vingt\",\"Dix\",\n            \"Neuf\",\"Huit\",\"Sept\",\"Six\",\"Cinq\",\"Quatre\",\"Trois\",\"Deux\",\"Un\"\n        ];\n        \n    }else{\n        \n        var number = [\"Ninety-nine\",\"Eighty-nine\",\"Seventy-nine\",\"Sixty-nine\",\"Fifty-nine\",\"Forty-nine\",\"Thirty-nine\",\"Twenty-nine\",\"Nineteen\",\n            \"Ninety-eight\",\"Eighty-eight\",\"Seventy-eight\",\"Sixty-eight\",\"Fifty-eight\",\"Forty-eight\",\"Thirty-eight\",\"Twenty-eight\",\"Eighteen\",\n            \"Ninety-seven\",\"Eighty-seven\",\"Seventy-seven\",\"Sixty-seven\",\"Fifty-seven\",\"Forty-seven\",\"Thirty-seven\",\"Twenty-seven\",\"Seventeen\",\n            \"Ninety-six\",\"Eighty-six\",\"Seventy-six\",\"Sixty-six\",\"Fifty-six\",\"Forty-six\",\"Thirty-six\",\"Twenty-six\",\"Sixteen\",\n            \"Ninety-five\",\"Eighty-five\",\"Seventy-five\",\"Sixty-five\",\"Fifty-five\",\"Forty-five\",\"Thirty-five\",\"Twenty-five\",\"Fifteen\",\n            \"Ninety-four\",\"Eighty-four\",\"Seventy-four\",\"Sixty-four\",\"Fifty-four\",\"Forty-four\",\"Thirty-four\",\"Twenty-four\",\"Fourteen\",\n            \"Ninety-three\",\"Eighty-three\",\"Seventy-three\",\"Sixty-three\",\"Fifty-three\",\"Forty-three\",\"Thirty-three\",\"Twenty-three\",\"Thirteen\",\n            \"Ninety-two\",\"Eighty-two\",\"Seventy-two\",\"Sixty-two\",\"Fifty-two\",\"Forty-two\",\"Thirty-two\",\"Twenty-two\",\"Twelve\",\n            \"Ninety-one\",\"Eighty-one\",\"Seventy-one\",\"Sixty-one\",\"Fifty-one\",\"Forty-one\",\"Thirty-one\",\"Twenty-one\",\"Eleven\",\n            \"One Hundred\",\"Ninety\",\"Eighty\",\"Seventy\",\"Sixty\",\"Fifty\",\"Forty\",\"Thirty\",\"Twenty\",\"Ten\",\n            \"Nine\",\"Eight\",\"Seven\",\"Six\",\"Five\",\"Four\",\"Three\",\"Two\",\"One\"\n        ];\n        \n    }\n    \n    var digit = [\"99\",\"89\",\"79\",\"69\",\"59\",\"49\",\"39\",\"29\",\"19\",\n        \"98\",\"88\",\"78\",\"68\",\"58\",\"48\",\"38\",\"28\",\"18\",\n        \"97\",\"87\",\"77\",\"67\",\"57\",\"47\",\"37\",\"27\",\"17\",\n        \"96\",\"86\",\"76\",\"66\",\"56\",\"46\",\"36\",\"26\",\"16\",\n        \"95\",\"85\",\"75\",\"65\",\"55\",\"45\",\"35\",\"25\",\"15\",\n        \"94\",\"84\",\"74\",\"64\",\"54\",\"44\",\"34\",\"24\",\"14\",\n        \"93\",\"83\",\"73\",\"63\",\"53\",\"43\",\"33\",\"23\",\"13\",\n        \"92\",\"82\",\"72\",\"62\",\"52\",\"42\",\"32\",\"22\",\"12\",\n        \"91\",\"81\",\"71\",\"61\",\"51\",\"41\",\"31\",\"21\",\"11\",\n        \"100\",\"90\",\"80\",\"70\",\"60\",\"50\",\"40\",\"30\",\"20\",\"10\",\n        \"9\",\"8\",\"7\",\"6\",\"5\",\"4\",\"3\",\"2\",\"1\"\n    ];\n    \n    var str = this;\n    for(var i = 0; i < digit.length; i++){\n        str = str.replace(digit[i], \" \"+number[i]+\" \");\n    }\n     \n    return str;\n}\n\nvar appList = [];\nvar globalList = [];\n\n// get title and uri\n\nfor(var i=0; i<msg.payload.length; i++){\n    appList.push({\"title\" : msg.payload[i].title, \"uri\" : msg.payload[i].uri});\n    globalList.push(msg.payload[i].title);\n    \n    if(msg.payload[i].title !== msg.payload[i].title.replaceDigitsWithNumbers()){\n        //append into new array\n        appList.push({\"title\" : msg.payload[i].title.replaceDigitsWithNumbers(), \"uri\" : msg.payload[i].uri});\n        globalList.push(msg.payload[i].title.replaceDigitsWithNumbers());\n    }\n}\n\nglobal.set(\"appList\", globalList);\nglobal.set(\"appListURI\", appList);\n\nmsg.payload = appList;\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "x": 505,
        "y": 1470,
        "wires": [
            []
        ],
        "l": false
    },
    {
        "id": "1479cb72.1f5455",
        "type": "function",
        "z": "5cb619a7.cb38e8",
        "g": "52e9d8db.6bfb78",
        "name": "Filter for channel",
        "func": "function findObjectByKey(array, key, value) {\n\titems = [];\n\tvar cpt = 0;\n\tfor (var i = 0; i < array.length; i++) {\n\t\tif (array[i][key] === value) {\n\t\t\titems[cpt] = array[i];\n\t\t\tcpt++;\n\t\t}\n\t}\n\tif (items[0] !== undefined) {\n\t\treturn items;\n\t} else {\n\t\treturn null;\n\t}\n}\n\nfunction isNumeric(str) {\n  if (typeof str != \"string\") return false  \n  return !isNaN(str) && \n         !isNaN(parseFloat(str))\n}\n\nvar find = flow.get(\"channelNumber\");\nvar remoteTV = global.get(\"remoteTV\");\nvar lang = global.get(\"msgLang\");\n\nString.prototype.replaceWithDigits = function(){\n    \n    if(lang == \"de\"){\n        \n        var number = [\"Neunundneunzig\",\"Neunundachtzig\",\"Neunundsiebzig\",\"Neunundsechzig\",\"Neunundfünfzig\",\"Neunundvierzig\",\"Neununddreiβig\",\"Neunundzwanzig\",\"Neunzehn\",\n            \"Achtundneunzig\",\"Achtundachtzig\",\"Achtundsiebzig\",\"Achtundsechzig\",\"Achtundfünfzig\",\"Achtundvierzig\",\"Achtunddreiβig\",\"Achtundzwanzig\",\"Achtzehn\",\n            \"Siebenundneunzig\",\"Siebenundachtzig\",\"Siebenundsiebzig\",\"Siebenundsechzig\",\"Siebenundfünfzig\",\"Siebenundvierzig\",\"Siebenunddreiβig\",\"Siebenundzwanzig\",\"Siebzehn\",\n            \"Sechsundneunzig\",\"Sechsundachtzig\",\"Sechsundsiebzig\",\"Sechsundsechzig\",\"Sechsundfünfzig\",\"Sechsundvierzig\",\"Sechsunddreiβig\",\"Sechsundzwanzig\",\"Sechzehn\",\n            \"Fünfundneunzig\",\"Fünfundachtzig\",\"Fünfundsiebzig\",\"Fünfundsechzig\",\"Fünfundfünfzig\",\"Fünfundvierzig\",\"Fünfunddreiβig\",\"Fünfundzwanzig\",\"Fünfzehn\",\n            \"Vierundneunzig\",\"Vierundachtzig\",\"Vierundsiebzig\",\"Vierundsechzig\",\"Vierundfünfzig\",\"Vierundvierzig\",\"Vierunddreiβig\",\"Vierundzwanzig\",\"Vierzehn\",\n            \"Dreiundneunzig\",\"Dreiundachtzig\",\"Dreiundsiebzig\",\"Dreiundsechzig\",\"Dreiundfünfzig\",\"Dreiundvierzig\",\"Dreiunddreiβig\",\"Dreiundzwanzig\",\"Dreizehn\",\n            \"Zweiundneunzig\",\"Zweiundachtzig\",\"Zweiundsiebzig\",\"Zweiundsechzig\",\"Zweiundfünfzig\",\"Zweiundvierzig\",\"Zweiunddreiβig\",\"Zweiundzwanzig\",\"Zwölf\",\n            \"Einundneunzig\",\"Einundachtzig\",\"Einundsiebzig\",\"Einundsechzig\",\"Einundfünfzig\",\"Einundvierzig\",\"Einunddreiβig\",\"Einundzwanzig\",\"Elf\",\n            \"Einhundert\",\"Neunzig\",\"Achtzig\",\"Siebzig\",\"Sechzig\",\"Fünfzig\",\"Vierzig\",\"Dreiβig\",\"Zwanzig\",\"Zehn\",\"Neun\",\"Acht\",\"Sieben\",\"Sechs\",\"Fünf\",\"Vier\",\"Drei\",\"Zwei\",\"Eins\"\n        ];\n\n        \n    }else if(lang == \"fr\"){\n        \n        var number = [\"Quatre-vingt-dix-neuf\",\"Quatre-vingt-neuf\",\"Soixante-dix-neuf \",\"Soixante-neuf\",\"Cinquante-neuf\",\"Quarante-neuf\",\" Trente-neuf \",\" Vingt-neuf \",\"Dix-neuf\",\n            \"Quatre-vingt-dix-huit\",\"Quatre-vingt-huit\", \"Soixante-dix-huit\",\" Soixante-huit\",\"Cinquante-huit\",\"Quarante-huit\",\"Trente-huit\",\"Vingt-huit\",\"Dix-huit\",\n            \"Quatre-vingt-dix-sept\",\"Quatre-vingt-sept\",\"Soixante-dix-sept\",\"Soixante-sept\",\"Cinquante-sept\",\"Quarante-sept\",\"Trente-sept\",\"Vingt-sept\",\"Dix-sept\",\n            \"Quatre-vingt-seize\",\"Quatre-vingt-six\",\"Soixante-six\",\"Soixante-six\",\"Cinquante-six\",\"Quarante-six\",\"Trente-six\",\"Vingt-six\",\"Seize\",\n            \"Quatre-vingt-quinze\",\"Quatre-vingt-cinq\",\"Soixante-quinze\",\"Soixante-cinq\",\"Cinquante-cinq\",\"Quarante-cinq\",\"Trente-cinq\",\"Vingt-cinq\",\"Quinze\",\n            \"Quatre-vingt-quatorze\",\"Quatre-vingt-quatre\",\"Soixante-quatorze\",\"Soixante-quatre\",\"Cinquante-quatre\",\"Quarante-quatre\",\"Trente-quatre\",\"Vingt-quatre\",\"Quatorze\",\n            \"Quatre-vingt-treize\",\"Quatre-vingt-trois\",\"Soixante-treize\",\"Soixante-trois\",\"Cinquante-trois\",\"Quarante-trois\",\"Trente-trois\",\"Vingt-trois\",\"Treize\",\n            \"Quatre-vingt-douze\",\"Quatre-vingt-deux\",\"Soixante-douze\",\"Soixante-deux\",\"Cinquante-deux\",\"Quarante-deux\",\"Trente-deux\",\"Vingt-deux\",\"Douze\",\n            \"Quatre-vingt-onze\",\"Quatre-vingt-un\",\"Soixante et onze\",\"Soixante et un\",\"Cinquante et un\",\"Quarante et un\",\"Trente et un\",\"Vingt et un\",\"Onze\",\n            \"Cent\",\"Quatre-vingt-dix\",\"Quatre-vingt\",\"Soixante-dix\",\"Soixante\",\"Cinquante\",\"Quarante\",\"Trente\",\"Vingt\",\"Dix\",\n            \"Neuf\",\"Huit\",\"Sept\",\"Six\",\"Cinq\",\"Quatre\",\"Trois\",\"Deux\",\"Un\"\n        ];\n        \n    }else{\n        \n        var number = [\"Ninety-nine\",\"Eighty-nine\",\"Seventy-nine\",\"Sixty-nine\",\"Fifty-nine\",\"Forty-nine\",\"Thirty-nine\",\"Twenty-nine\",\"Nineteen\",\n            \"Ninety-eight\",\"Eighty-eight\",\"Seventy-eight\",\"Sixty-eight\",\"Fifty-eight\",\"Forty-eight\",\"Thirty-eight\",\"Twenty-eight\",\"Eighteen\",\n            \"Ninety-seven\",\"Eighty-seven\",\"Seventy-seven\",\"Sixty-seven\",\"Fifty-seven\",\"Forty-seven\",\"Thirty-seven\",\"Twenty-seven\",\"Seventeen\",\n            \"Ninety-six\",\"Eighty-six\",\"Seventy-six\",\"Sixty-six\",\"Fifty-six\",\"Forty-six\",\"Thirty-six\",\"Twenty-six\",\"Sixteen\",\n            \"Ninety-five\",\"Eighty-five\",\"Seventy-five\",\"Sixty-five\",\"Fifty-five\",\"Forty-five\",\"Thirty-five\",\"Twenty-five\",\"Fifteen\",\n            \"Ninety-four\",\"Eighty-four\",\"Seventy-four\",\"Sixty-four\",\"Fifty-four\",\"Forty-four\",\"Thirty-four\",\"Twenty-four\",\"Fourteen\",\n            \"Ninety-three\",\"Eighty-three\",\"Seventy-three\",\"Sixty-three\",\"Fifty-three\",\"Forty-three\",\"Thirty-three\",\"Twenty-three\",\"Thirteen\",\n            \"Ninety-two\",\"Eighty-two\",\"Seventy-two\",\"Sixty-two\",\"Fifty-two\",\"Forty-two\",\"Thirty-two\",\"Twenty-two\",\"Twelve\",\n            \"Ninety-one\",\"Eighty-one\",\"Seventy-one\",\"Sixty-one\",\"Fifty-one\",\"Forty-one\",\"Thirty-one\",\"Twenty-one\",\"Eleven\",\n            \"One Hundred\",\"Ninety\",\"Eighty\",\"Seventy\",\"Sixty\",\"Fifty\",\"Forty\",\"Thirty\",\"Twenty\",\"Ten\",\n            \"Nine\",\"Eight\",\"Seven\",\"Six\",\"Five\",\"Four\",\"Three\",\"Two\",\"One\"\n        ];\n        \n    }\n    \n    var digit = [\"99\",\"89\",\"79\",\"69\",\"59\",\"49\",\"39\",\"29\",\"19\",\n        \"98\",\"88\",\"78\",\"68\",\"58\",\"48\",\"38\",\"28\",\"18\",\n        \"97\",\"87\",\"77\",\"67\",\"57\",\"47\",\"37\",\"27\",\"17\",\n        \"96\",\"86\",\"76\",\"66\",\"56\",\"46\",\"36\",\"26\",\"16\",\n        \"95\",\"85\",\"75\",\"65\",\"55\",\"45\",\"35\",\"25\",\"15\",\n        \"94\",\"84\",\"74\",\"64\",\"54\",\"44\",\"34\",\"24\",\"14\",\n        \"93\",\"83\",\"73\",\"63\",\"53\",\"43\",\"33\",\"23\",\"13\",\n        \"92\",\"82\",\"72\",\"62\",\"52\",\"42\",\"32\",\"22\",\"12\",\n        \"91\",\"81\",\"71\",\"61\",\"51\",\"41\",\"31\",\"21\",\"11\",\n        \"100\",\"90\",\"80\",\"70\",\"60\",\"50\",\"40\",\"30\",\"20\",\"10\",\n        \"9\",\"8\",\"7\",\"6\",\"5\",\"4\",\"3\",\"2\",\"1\"\n    ];\n    \n    var str = this;\n    for(var i = 0; i < number.length; i++){\n        str = str.replace(\"-\", \" \").replace(number[i].toLowerCase().replace(\"-\", \" \").trim(), digit[i]);\n    }\n     \n    return str;\n}\n\nvar channelNumber = find.replaceWithDigits();\n//node.warn(\"channelNumber : \" + channelNumber);\n\n\nif(isNumeric(channelNumber) === false){\n    \n    if(parseInt(channelNumber) === NaN){\n        var num = parseInt(channelNumber);\n        channelNumber = num.toString();\n        node.warn(\"channelNumber is not numeric, channelNumber : \" + channelNumber);\n    }else{\n        return null;\n    }\n}\n\nfor(var k=0; k<channelNumber.length; k++){\n    var button = findObjectByKey(remoteTV, \"name\", channelNumber[k]);\n    node.send(msg = {payload: button[0].value});\n    //node.send(msg = {payload: \"Num\"+channelNumber[k]});\n}\n\n\nif(channelNumber.length != 0){\n    var button = findObjectByKey(remoteTV, \"name\", \"confirm\");\n    node.send(msg = {payload: button[0].value});\n    //node.send(msg = {payload: \"Confirm\"});\n\n}\n\n",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "x": 680,
        "y": 810,
        "wires": [
            [
                "f43e5fe2.dcfaa"
            ]
        ]
    },
    {
        "id": "d78f10a9.4f8ac",
        "type": "inject",
        "z": "5cb619a7.cb38e8",
        "g": "52e9d8db.6bfb78",
        "name": "",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": true,
        "onceDelay": "3",
        "topic": "",
        "payload": "[{\"name\":\"0\",\"value\":\"AAAAAQAAAAEAAAAJAw==\"},{\"name\":\"1\",\"value\":\"AAAAAQAAAAEAAAAAAw==\"},{\"name\":\"2\",\"value\":\"AAAAAQAAAAEAAAABAw==\"},{\"name\":\"3\",\"value\":\"AAAAAQAAAAEAAAACAw==\"},{\"name\":\"4\",\"value\":\"AAAAAQAAAAEAAAADAw==\"},{\"name\":\"5\",\"value\":\"AAAAAQAAAAEAAAAEAw==\"},{\"name\":\"6\",\"value\":\"AAAAAQAAAAEAAAAFAw==\"},{\"name\":\"7\",\"value\":\"AAAAAQAAAAEAAAAGAw==\"},{\"name\":\"8\",\"value\":\"AAAAAQAAAAEAAAAHAw==\"},{\"name\":\"9\",\"value\":\"AAAAAQAAAAEAAAAIAw==\"},{\"name\":\"confirm\",\"value\":\"AAAAAQAAAAEAAABlAw==\"}]",
        "payloadType": "json",
        "x": 200,
        "y": 1550,
        "wires": [
            [
                "e880f657.041788"
            ]
        ],
        "l": false
    },
    {
        "id": "e880f657.041788",
        "type": "function",
        "z": "5cb619a7.cb38e8",
        "g": "52e9d8db.6bfb78",
        "name": "",
        "func": "global.set(\"remoteTV\", msg.payload);\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "x": 285,
        "y": 1550,
        "wires": [
            []
        ],
        "l": false
    },
    {
        "id": "edd637a5.c5c788",
        "type": "bravia-ircc",
        "z": "5cb619a7.cb38e8",
        "g": "52e9d8db.6bfb78",
        "tv": "204aae5a.40fb72",
        "ircc": "",
        "name": "Button",
        "x": 890,
        "y": 810,
        "wires": []
    },
    {
        "id": "f43e5fe2.dcfaa",
        "type": "delay",
        "z": "5cb619a7.cb38e8",
        "g": "52e9d8db.6bfb78",
        "name": "",
        "pauseType": "rate",
        "timeout": "20",
        "timeoutUnits": "milliseconds",
        "rate": "1",
        "nbRateUnits": "1",
        "rateUnits": "second",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": false,
        "x": 805,
        "y": 810,
        "wires": [
            [
                "edd637a5.c5c788"
            ]
        ],
        "l": false
    },
    {
        "id": "581b1e84.8ed8f",
        "type": "bravia-api",
        "z": "5cb619a7.cb38e8",
        "g": "52e9d8db.6bfb78",
        "tv": "204aae5a.40fb72",
        "method": "avContent:1.0:setPlayContent",
        "payload": "",
        "name": "setPlayContent",
        "x": 475,
        "y": 770,
        "wires": [
            []
        ]
    },
    {
        "id": "af97c54f.555a28",
        "type": "change",
        "z": "5cb619a7.cb38e8",
        "g": "52e9d8db.6bfb78",
        "name": "Save",
        "rules": [
            {
                "t": "set",
                "p": "tvFavorites",
                "pt": "global",
                "to": "payload",
                "tot": "msg"
            },
            {
                "t": "set",
                "p": "useTvFavorites",
                "pt": "global",
                "to": "true",
                "tot": "bool"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 720,
        "y": 290,
        "wires": [
            []
        ]
    },
    {
        "id": "6300ac18.111804",
        "type": "mqtt-broker",
        "z": "5cb619a7.cb38e8",
        "name": "-",
        "broker": "localhost",
        "port": "1883",
        "clientid": "",
        "usetls": false,
        "compatmode": true,
        "keepalive": "60",
        "cleansession": true,
        "birthTopic": "",
        "birthQos": "0",
        "birthPayload": "",
        "closeTopic": "",
        "closeQos": "0",
        "closePayload": "",
        "willTopic": "",
        "willQos": "0",
        "willPayload": "",
        "info": "-"
    },
    {
        "id": "204aae5a.40fb72",
        "type": "bravia-tv",
        "name": "SONY BRAVIA TV",
        "host": "192.168.x.x",
        "port": "80",
        "psk": "xxxx",
        "timeout": "5000"
    }
]
